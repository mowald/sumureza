<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SUMUREZA GENERAL SUPPLIES ‚Äî Business Suite</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{
  --ink:#0f1923;--ink-soft:#3a4a5a;--ink-muted:#7a8a9a;
  --gold:#c8962a;--gold-light:#f0c96a;--gold-pale:#fdf6e3;
  --cream:#faf8f4;--white:#fff;--border:#e2ddd4;--border-dark:#ccc4b4;
  --green:#1a6b45;--green-bg:#e6f4ed;
  --red:#8b2020;--red-bg:#faeaea;
  --blue:#1a3a6b;--blue-bg:#e6ecf4;
  --purple:#4a1a6b;--purple-bg:#f0eaf8;
  --orange:#b85c00;--orange-bg:#fef0e0;
  --teal:#0d6b6b;--teal-bg:#e0f4f4;
  --s1:0 1px 3px rgba(15,25,35,.08);
  --s2:0 4px 16px rgba(15,25,35,.12);
  --s3:0 12px 40px rgba(15,25,35,.18);
  --r:6px;
}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;}
body{font-family:'DM Sans',sans-serif;background:var(--cream);color:var(--ink);display:flex;overflow:hidden;height:100vh;}

/* SIDEBAR */
.sb{width:248px;min-width:248px;background:linear-gradient(175deg,#0d1720 0%,#152030 100%);display:flex;flex-direction:column;border-right:1px solid rgba(200,150,42,.18);overflow-y:auto;overflow-x:hidden;}
.sb::-webkit-scrollbar{width:3px;} .sb::-webkit-scrollbar-thumb{background:rgba(200,150,42,.2);}
.brand{padding:20px 18px 16px;border-bottom:1px solid rgba(200,150,42,.12);}
.brand-pill{background:var(--gold);color:var(--ink);font-size:8.5px;font-weight:700;letter-spacing:2px;text-transform:uppercase;padding:2px 7px;border-radius:20px;display:inline-block;margin-bottom:7px;}
.brand h1{font-family:'Playfair Display',serif;font-size:15px;font-weight:900;color:#fff;line-height:1.3;}
.brand p{font-size:9.5px;color:rgba(240,201,106,.55);margin-top:2px;}
.nav-sec{padding:13px 14px 3px;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:rgba(200,150,42,.4);font-weight:700;}
.ni{display:flex;align-items:center;gap:9px;margin:1px 8px;padding:9px 11px;border-radius:var(--r);cursor:pointer;color:rgba(255,255,255,.48);font-size:12.5px;font-weight:500;transition:all .16s;position:relative;white-space:nowrap;}
.ni:hover{background:rgba(255,255,255,.05);color:rgba(255,255,255,.82);}
.ni.active{background:rgba(200,150,42,.14);color:var(--gold-light);border:1px solid rgba(200,150,42,.22);}
.ni.active::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:3px;height:16px;background:var(--gold);border-radius:0 2px 2px 0;}
.ni-ico{font-size:14px;width:17px;text-align:center;flex-shrink:0;}
.drive-w{margin:8px;padding:10px 12px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.07);border-radius:var(--r);}
.drive-row{display:flex;align-items:center;gap:7px;}
.dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;transition:background .3s;}
.dot.off{background:#3a3a3a;}.dot.warn{background:#e08c20;}.dot.on{background:#27ae60;}
#dlbl{color:rgba(255,255,255,.38);font-size:10.5px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
#dbtn{display:none;margin-top:7px;width:100%;padding:6px;background:var(--gold);border:none;border-radius:4px;font-family:'DM Sans',sans-serif;font-size:10.5px;font-weight:700;color:var(--ink);cursor:pointer;}
#dbtn:hover{background:#b8841e;}
.sb-foot{margin-top:auto;padding:12px 14px;border-top:1px solid rgba(200,150,42,.08);font-size:9.5px;color:rgba(255,255,255,.18);line-height:1.6;}

/* MAIN */
.main{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.topbar{background:#fff;border-bottom:1px solid var(--border);padding:12px 28px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;box-shadow:var(--s1);z-index:50;}
.ptitle{font-family:'Playfair Display',serif;font-size:18px;font-weight:700;}
.psub{font-size:11px;color:var(--ink-muted);margin-top:1px;}
.content{flex:1;overflow-y:auto;padding:24px 28px;}
.content::-webkit-scrollbar{width:5px;}.content::-webkit-scrollbar-thumb{background:#ddd;border-radius:3px;}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:var(--r);font-size:12.5px;font-weight:600;cursor:pointer;border:none;font-family:'DM Sans',sans-serif;transition:all .16s;white-space:nowrap;}
.bg{background:var(--gold);color:var(--ink);box-shadow:0 2px 6px rgba(200,150,42,.28);}
.bg:hover{background:#b8841e;transform:translateY(-1px);}
.bgreen{background:var(--green);color:#fff;} .bgreen:hover{background:#145538;transform:translateY(-1px);}
.bout{background:transparent;color:var(--ink);border:1.5px solid var(--border-dark);} .bout:hover{background:var(--ink);color:#fff;}
.bred{background:var(--red);color:#fff;} .bred:hover{background:#6b1515;}
.bblue{background:var(--blue);color:#fff;} .bblue:hover{background:#102a52;}
.bsm{padding:5px 11px;font-size:11.5px;} .bxs{padding:3px 8px;font-size:11px;}

/* CARDS */
.card{background:#fff;border:1px solid var(--border);border-radius:8px;box-shadow:var(--s1);overflow:hidden;margin-bottom:18px;}
.ch{padding:14px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:linear-gradient(90deg,#faf8f4,#fff);}
.ch h3{font-family:'Playfair Display',serif;font-size:14px;font-weight:700;display:flex;align-items:center;gap:7px;}
.cb{padding:20px;}

/* FORM */
.fg2{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.fg3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;}
.fg4{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;}
.s2{grid-column:span 2;}.s3{grid-column:span 3;}.s4{grid-column:span 4;}
.fg{display:flex;flex-direction:column;gap:4px;}
.fl{font-size:10.5px;font-weight:700;color:var(--ink-soft);letter-spacing:.4px;text-transform:uppercase;}
.fi,.fs,.ft{font-family:'DM Sans',sans-serif;font-size:13px;color:var(--ink);border:1.5px solid var(--border);border-radius:var(--r);padding:8px 12px;background:#fff;outline:none;transition:border-color .2s,box-shadow .2s;width:100%;}
.fi:focus,.fs:focus,.ft:focus{border-color:var(--gold);box-shadow:0 0 0 3px rgba(200,150,42,.1);}
.ft{resize:vertical;min-height:66px;}

/* TABLES */
.tbl{width:100%;border-collapse:collapse;}
.tbl thead th{background:var(--ink);color:#fff;font-size:10px;letter-spacing:.8px;text-transform:uppercase;padding:10px 13px;text-align:left;font-weight:600;white-space:nowrap;}
.tbl tbody tr{border-bottom:1px solid var(--border);transition:background .1s;}
.tbl tbody tr:hover{background:var(--gold-pale);}
.tbl td{padding:10px 13px;font-size:12.5px;vertical-align:middle;}
.tbl .mono{font-family:'DM Mono',monospace;font-size:12px;}
.tbl .nr{text-align:right;}
.tbl .nc{text-align:center;}
.erow td{text-align:center;color:var(--ink-muted);padding:36px;font-size:13px;}

/* KPI GRID */
.kgrid{display:grid;gap:14px;margin-bottom:20px;}
.kg4{grid-template-columns:repeat(4,1fr);}
.kg3{grid-template-columns:repeat(3,1fr);}
.kpi{background:#fff;border:1px solid var(--border);border-radius:8px;padding:16px 18px;position:relative;overflow:hidden;box-shadow:var(--s1);}
.kpi::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;}
.kg::before{background:var(--green);}.kr::before{background:var(--red);}
.ko::before{background:var(--gold);}.kb::before{background:var(--blue);}
.kp::before{background:var(--purple);}.kt::before{background:var(--teal);}
.kpi-lbl{font-size:10.5px;font-weight:700;color:var(--ink-muted);letter-spacing:.4px;text-transform:uppercase;margin-bottom:5px;}
.kpi-val{font-family:'Playfair Display',serif;font-size:20px;font-weight:900;color:var(--ink);line-height:1.1;}
.kpi-sub{font-size:10.5px;color:var(--ink-muted);margin-top:3px;}

/* CHIPS */
.chip{display:inline-block;padding:2px 8px;border-radius:20px;font-size:10px;font-weight:700;letter-spacing:.3px;text-transform:uppercase;}
.cg{background:var(--green-bg);color:var(--green);}.cr{background:var(--red-bg);color:var(--red);}
.co{background:#fff3d0;color:#7a5800;}.cb2{background:var(--blue-bg);color:var(--blue);}
.cp{background:var(--purple-bg);color:var(--purple);}.cgr{background:#f0f0f0;color:#555;}
.ct{background:var(--teal-bg);color:var(--teal);}

/* ITEMS TABLE IN FORMS */
.itbl{width:100%;border-collapse:collapse;}
.itbl thead th{background:var(--ink);color:#fff;font-size:9.5px;letter-spacing:.8px;text-transform:uppercase;padding:9px 9px;text-align:left;font-weight:600;}
.itbl tbody tr{border-bottom:1px solid var(--border);}
.itbl td{padding:5px 5px;vertical-align:middle;}
.itbl td input,.itbl td select{font-family:'DM Sans',sans-serif;font-size:12.5px;color:var(--ink);border:1.5px solid transparent;border-radius:4px;padding:5px 7px;background:transparent;width:100%;outline:none;transition:all .14s;}
.itbl td input:focus,.itbl td select:focus{background:#fff;border-color:var(--gold);}
.itbl .ac{text-align:right;font-family:'DM Mono',monospace;font-size:12px;color:var(--ink-soft);padding-right:10px;}
.delbtn{background:none;border:none;cursor:pointer;color:var(--ink-muted);font-size:15px;padding:2px 5px;border-radius:3px;transition:all .14s;}
.delbtn:hover{color:var(--red);background:var(--red-bg);}
.add-row{width:100%;padding:10px;background:var(--gold-pale);border:1.5px dashed #d4b86a;color:var(--gold);font-size:12.5px;font-weight:600;cursor:pointer;border-radius:0 0 6px 6px;font-family:'DM Sans',sans-serif;transition:all .18s;display:flex;align-items:center;justify-content:center;gap:7px;}
.add-row:hover{background:#f5eedb;}

/* TOTALS */
.twrap{display:flex;justify-content:flex-end;padding:14px 18px;border-top:1px solid var(--border);}
.tbox{min-width:280px;}
.trow{display:flex;justify-content:space-between;align-items:center;padding:7px 12px;border-bottom:1px solid var(--border);font-size:12.5px;}
.trow:last-child{border:none;}
.trow .tl{color:var(--ink-soft);font-weight:500;}
.trow .tv{font-family:'DM Mono',monospace;font-weight:500;}
.trow.grand{background:var(--ink);border-radius:5px;margin-top:5px;font-weight:700;font-size:14px;}
.trow.grand .tl{color:rgba(255,255,255,.7);}
.trow.grand .tv{color:var(--gold-light);}
.disc-in{width:60px;border:1.5px solid var(--border);border-radius:3px;padding:3px 6px;font-family:'DM Mono',monospace;text-align:right;outline:none;font-size:12px;}

/* MODAL */
.mbg{display:none;position:fixed;inset:0;background:rgba(10,18,28,.82);z-index:500;overflow-y:auto;padding:24px;backdrop-filter:blur(3px);}
.mbg.open{display:flex;align-items:flex-start;justify-content:center;}
.mbox{background:#fff;width:100%;border-radius:10px;box-shadow:var(--s3);overflow:hidden;}
.mtop{background:var(--ink);padding:13px 20px;display:flex;align-items:center;justify-content:space-between;}
.mtop h3{color:#fff;font-family:'Playfair Display',serif;font-size:15px;}
.mx{background:none;border:none;color:rgba(255,255,255,.45);cursor:pointer;font-size:20px;line-height:1;transition:color .15s;}
.mx:hover{color:#fff;}
.mbody{padding:22px;}
.mfoot{padding:12px 20px;background:#f8f7f5;border-top:1px solid var(--border);display:flex;gap:9px;justify-content:flex-end;}

/* DOC PAPER */
.docpaper{padding:42px 48px;font-family:'DM Sans',sans-serif;color:#0f1923;background:#fff;}
.dh{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:32px;padding-bottom:22px;border-bottom:3px solid #0f1923;position:relative;}
.dh::after{content:'';position:absolute;bottom:-6px;left:0;right:0;height:1.5px;background:#c8962a;}
.dco h2{font-family:'Playfair Display',serif;font-size:21px;font-weight:900;}
.dco .dtl{font-size:9px;color:#c8962a;letter-spacing:2px;text-transform:uppercase;margin-top:3px;font-weight:700;}
.dco .dci{margin-top:9px;font-size:10.5px;color:#3a4a5a;line-height:1.7;}
.dtn{font-family:'Playfair Display',serif;font-size:26px;font-weight:900;text-align:right;}
.dref{font-family:'DM Mono',monospace;font-size:11.5px;color:#7a8a9a;text-align:right;margin-top:3px;}
.dmeta{font-size:10.5px;color:#7a8a9a;text-align:right;margin-top:2px;}
.dpar{display:grid;grid-template-columns:1fr 1fr;gap:22px;margin-bottom:26px;}
.dp2 h4{font-size:8.5px;letter-spacing:2px;text-transform:uppercase;color:#c8962a;font-weight:700;margin-bottom:5px;}
.dp2 .dpn{font-family:'Playfair Display',serif;font-size:13px;font-weight:700;}
.dp2 p{font-size:10.5px;color:#3a4a5a;line-height:1.7;}
.dtable{width:100%;border-collapse:collapse;margin-bottom:8px;}
.dtable thead th{background:#0f1923;color:#fff;font-size:8.5px;letter-spacing:1.5px;text-transform:uppercase;padding:8px 11px;font-weight:600;text-align:left;}
.dtable thead th.r{text-align:right;}.dtable thead th.c{text-align:center;}
.dtable tbody tr{border-bottom:1px solid #e8e4dc;}
.dtable tbody tr:nth-child(even){background:#faf8f4;}
.dtable td{padding:8px 11px;font-size:11.5px;}
.dtable td.r{text-align:right;font-family:'DM Mono',monospace;}
.dtable td.c{text-align:center;}
.dtrbox{min-width:250px;}
.dtr{display:flex;justify-content:space-between;padding:5px 0;font-size:12px;border-bottom:1px dashed #e8e4dc;}
.dtr:last-child{border:none;}
.dtr.grand{font-weight:700;font-size:13.5px;padding:9px 13px;background:#0f1923;color:#fff;border-radius:4px;margin-top:5px;border:none;}
.dtr.grand span:last-child{color:#f0c96a;font-family:'DM Mono',monospace;}
.dnote{font-size:10.5px;color:#3a4a5a;padding:10px 14px;border-left:3px solid #c8962a;background:#fdf6e3;border-radius:0 4px 4px 0;margin-bottom:22px;}
.dfooter{border-top:2px solid #0f1923;padding-top:16px;display:flex;justify-content:space-between;}
.sig{text-align:center;}
.sigline{width:120px;border-bottom:1px solid #0f1923;margin:0 auto 4px;padding-bottom:24px;}
.siglbl{font-size:9.5px;color:#7a8a9a;}

/* REPORT */
.report-section{background:#fff;border:1px solid var(--border);border-radius:8px;margin-bottom:18px;overflow:hidden;}
.rs-head{padding:12px 20px;background:var(--ink);color:#fff;font-family:'Playfair Display',serif;font-size:14px;font-weight:700;}
.rs-body{padding:0;}
.rs-row{display:flex;justify-content:space-between;align-items:center;padding:10px 20px;border-bottom:1px solid var(--border);font-size:13px;}
.rs-row:last-child{border:none;}
.rs-row .rl{color:var(--ink-soft);}
.rs-row .rv{font-family:'DM Mono',monospace;font-weight:600;}
.rs-row.subtotal{background:#f8f7f5;font-weight:700;}
.rs-row.total{background:var(--ink);color:#fff;}
.rs-row.total .rl{color:rgba(255,255,255,.75);}
.rs-row.total .rv{color:var(--gold-light);}
.rs-row.positive .rv{color:var(--green);}
.rs-row.negative .rv{color:var(--red);}
.rs-row.indent .rl{padding-left:20px;}

/* SYNC / TOAST */
.syncbar{display:none;position:fixed;bottom:18px;right:18px;background:var(--ink);color:#fff;padding:9px 14px;border-radius:6px;font-size:11.5px;z-index:999;box-shadow:var(--s2);border-left:3px solid var(--gold);align-items:center;gap:9px;}
.syncbar.show{display:flex;}
.spin{animation:spin 1s linear infinite;display:inline-block;}
@keyframes spin{to{transform:rotate(360deg);}}
.toast{position:fixed;bottom:18px;right:18px;background:var(--ink);color:#fff;padding:12px 16px;border-radius:8px;box-shadow:var(--s3);z-index:9999;max-width:300px;font-size:12.5px;border-left:4px solid var(--green);animation:slideUp .3s ease;font-family:'DM Sans',sans-serif;}
@keyframes slideUp{from{transform:translateY(16px);opacity:0;}to{transform:translateY(0);opacity:1;}}
.tab-bar{display:flex;border-bottom:2px solid var(--border);margin-bottom:18px;}
.tab{padding:8px 16px;cursor:pointer;font-size:12.5px;font-weight:600;color:var(--ink-muted);border-bottom:2.5px solid transparent;margin-bottom:-2px;transition:all .15s;}
.tab:hover{color:var(--ink);}.tab.active{color:var(--gold);border-color:var(--gold);}
.actions-row{display:flex;gap:9px;justify-content:flex-end;margin-top:14px;}
.section-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
.section-hd h2{font-family:'Playfair Display',serif;font-size:16px;font-weight:700;}
input[type=checkbox]{accent-color:var(--gold);}
.alert-box{padding:14px 18px;border-radius:var(--r);font-size:13px;margin-bottom:16px;}
.alert-warn{background:#fff8e6;border:1px solid #f0c96a;color:#6b5000;}
.alert-info{background:var(--blue-bg);border:1px solid #b8cce8;color:var(--blue);}
.alert-ok{background:var(--green-bg);border:1px solid #a8d8bc;color:var(--green);}
.alert-err{background:var(--red-bg);border:1px solid #e8b8b8;color:var(--red);}
.divider{height:1px;background:var(--border);margin:16px 0;}
.badge-num{background:var(--red);color:#fff;font-size:10px;font-weight:700;padding:1px 6px;border-radius:20px;margin-left:5px;}

/* SETUP STEPS */
.sstep{display:flex;gap:14px;margin-bottom:16px;padding:18px;background:#fff;border:1px solid var(--border);border-radius:8px;}
.snum{width:30px;height:30px;border-radius:50%;background:var(--ink);color:#fff;font-weight:700;font-size:13px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.sbody h4{font-size:13px;font-weight:700;margin-bottom:4px;}
.sbody p{font-size:12px;color:var(--ink-soft);line-height:1.6;}
.sbody code{background:#f0f0f0;padding:1px 5px;border-radius:3px;font-family:'DM Mono',monospace;font-size:11.5px;}
.slink{display:inline-flex;align-items:center;gap:5px;padding:5px 11px;background:var(--blue-bg);color:var(--blue);border-radius:4px;font-size:11.5px;font-weight:600;text-decoration:none;border:1px solid #c4d4e8;margin-top:7px;}

@media print{body *{visibility:hidden;}.docpaper,.docpaper *{visibility:visible;}.docpaper{position:fixed;top:0;left:0;width:100%;padding:28px 36px;}}

/* PIN AUTH */
.pin-screen{position:fixed;inset:0;background:linear-gradient(135deg,#0d1720 0%,#152030 60%,#1a2a40 100%);z-index:9999;display:flex;align-items:center;justify-content:center;}
.pin-box{background:rgba(255,255,255,.04);border:1px solid rgba(200,150,42,.2);border-radius:16px;padding:40px 36px;width:340px;text-align:center;box-shadow:0 24px 64px rgba(0,0,0,.4);}
.pin-logo{font-family:'Playfair Display',serif;font-size:18px;font-weight:900;color:#fff;line-height:1.3;margin-bottom:4px;}
.pin-tag{font-size:10px;color:rgba(200,150,42,.6);letter-spacing:2px;text-transform:uppercase;margin-bottom:28px;}
.pin-dots{display:flex;gap:12px;justify-content:center;margin-bottom:24px;}
.pin-dot{width:14px;height:14px;border-radius:50%;border:2px solid rgba(200,150,42,.4);background:transparent;transition:all .2s;}
.pin-dot.filled{background:var(--gold);border-color:var(--gold);box-shadow:0 0 8px rgba(200,150,42,.4);}
.pin-dot.error{background:#8b2020;border-color:#8b2020;animation:shake .3s ease;}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-4px)}75%{transform:translateX(4px)}}
.pin-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:14px;}
.pin-btn{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:10px;color:#fff;font-family:'DM Sans',sans-serif;font-size:20px;font-weight:600;padding:16px;cursor:pointer;transition:all .15s;user-select:none;}
.pin-btn:hover{background:rgba(200,150,42,.18);border-color:rgba(200,150,42,.4);}
.pin-btn:active{transform:scale(.94);background:rgba(200,150,42,.3);}
.pin-btn.del{font-size:13px;color:rgba(255,255,255,.5);}
.pin-btn.del:hover{color:#fff;}
.pin-err{color:#e07070;font-size:12px;min-height:18px;margin-top:6px;font-weight:600;}
.pin-user-sel{display:flex;flex-direction:column;gap:8px;margin-bottom:20px;}
.pin-user-btn{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:8px;color:#fff;font-family:'DM Sans',sans-serif;font-size:13px;padding:11px 16px;cursor:pointer;text-align:left;display:flex;align-items:center;gap:10px;transition:all .15s;}
.pin-user-btn:hover{background:rgba(200,150,42,.15);border-color:rgba(200,150,42,.35);}
.pin-user-role{font-size:10px;color:rgba(200,150,42,.7);text-transform:uppercase;letter-spacing:1px;margin-top:1px;}
.pin-who{font-size:12.5px;color:rgba(255,255,255,.5);margin-bottom:18px;line-height:1.5;}
</style>
</head>
<body>

<!-- PIN LOCK SCREEN -->
<div class="pin-screen" id="pinScreen">
  <div class="pin-box">
    <div class="pin-logo">SUMUREZA<br>GENERAL SUPPLIES</div>
    <div class="pin-tag">Secure Access</div>
    <div id="pinUserSel">
      <div class="pin-who">Select your name to sign in</div>
      <div class="pin-user-sel" id="pinUserList">
        <div style="color:rgba(255,255,255,.3);font-size:12px;text-align:center;padding:12px">Loading users...</div>
      </div>
    </div>
    <div id="pinEntry" style="display:none">
      <div class="pin-who" id="pinWhoLbl">Enter your PIN</div>
      <div class="pin-dots" id="pinDots"></div>
      <div class="pin-grid">
        <button class="pin-btn" onclick="pinPress('1')">1</button>
        <button class="pin-btn" onclick="pinPress('2')">2</button>
        <button class="pin-btn" onclick="pinPress('3')">3</button>
        <button class="pin-btn" onclick="pinPress('4')">4</button>
        <button class="pin-btn" onclick="pinPress('5')">5</button>
        <button class="pin-btn" onclick="pinPress('6')">6</button>
        <button class="pin-btn" onclick="pinPress('7')">7</button>
        <button class="pin-btn" onclick="pinPress('8')">8</button>
        <button class="pin-btn" onclick="pinPress('9')">9</button>
        <button class="pin-btn del" onclick="pinBack()">‚å´ Del</button>
        <button class="pin-btn" onclick="pinPress('0')">0</button>
        <button class="pin-btn del" onclick="pinClear()">‚úï</button>
      </div>
      <div class="pin-err" id="pinErr"></div>
      <div style="margin-top:14px"><button onclick="showUserSel()" style="background:none;border:none;color:rgba(255,255,255,.28);font-size:11.5px;cursor:pointer;font-family:'DM Sans',sans-serif;">‚Üê Change user</button></div>
    </div>
  </div>
</div>

<!-- SIDEBAR -->
<aside class="sb">
  <div class="brand">
    <div class="brand-pill">Business Suite</div>
    <h1>SUMUREZA<br>GENERAL SUPPLIES</h1>
    <p>Accounting & Management</p>
  </div>
  <div class="nav-sec">Overview</div>
  <div class="ni active" onclick="nav('dashboard')"><span class="ni-ico">üìä</span>Dashboard</div>
  <div class="nav-sec">Documents</div>
  <div class="ni" onclick="nav('quotations')"><span class="ni-ico">üìã</span>Quotations</div>
  <div class="ni" onclick="nav('purchase_orders')"><span class="ni-ico">üõí</span>Purchase Orders</div>
  <div class="ni" onclick="nav('invoices')"><span class="ni-ico">üßæ</span>Invoices</div>
  <div class="ni" onclick="nav('delivery')"><span class="ni-ico">üöö</span>Delivery Notes</div>
  <div class="ni" onclick="nav('receipts')"><span class="ni-ico">‚úÖ</span>Receipts</div>
  <div class="nav-sec">Finance</div>
  <div class="ni" onclick="nav('income')"><span class="ni-ico">üí∞</span>Income</div>
  <div class="ni" onclick="nav('expenses')"><span class="ni-ico">üí∏</span>Expenses</div>
  <div class="ni" onclick="nav('bank')"><span class="ni-ico">üè¶</span>Bank Reconciliation</div>
  <div class="nav-sec">Reports</div>
  <div class="ni" onclick="nav('pnl')"><span class="ni-ico">üìà</span>Profit & Loss</div>
  <div class="ni" onclick="nav('balance_sheet')"><span class="ni-ico">‚öñÔ∏è</span>Balance Sheet</div>
  <div class="ni" onclick="nav('vat')"><span class="ni-ico">üèõÔ∏è</span>VAT / Tax Summary</div>
  <div class="ni" onclick="nav('aged_debtors')"><span class="ni-ico">‚è∞</span>Aged Debtors</div>
  <div class="nav-sec">Operations</div>
  <div class="ni" onclick="nav('inventory')"><span class="ni-ico">üì¶</span>Inventory</div>
  <div class="ni" onclick="nav('clients')"><span class="ni-ico">üë•</span>Clients</div>
  <div class="ni" onclick="nav('suppliers')"><span class="ni-ico">üè≠</span>Suppliers</div>
  <div class="nav-sec">Settings</div>
  <div class="ni" onclick="nav('settings')"><span class="ni-ico">‚öôÔ∏è</span>Company Settings</div>
  <div class="ni" onclick="nav('gdrive')"><span class="ni-ico">‚òÅÔ∏è</span>Google Drive</div>
  <div class="ni" onclick="nav('pin_management')" id="ni-pin" style="display:none"><span class="ni-ico">üîê</span>PIN Management</div>
  <div class="drive-w">
    <div class="drive-row"><span class="dot off" id="ddot"></span><span id="dlbl">Drive not configured</span></div>
    <button id="dbtn" onclick="driveSignIn()">üîó Connect Drive</button>
  </div>
  <div class="sb-foot">
    <div style="margin-bottom:8px" id="curUserBar" style="display:none"></div>
    <button onclick="lockApp()" id="lockBtn" style="display:none;width:100%;padding:7px;background:rgba(139,32,32,.25);border:1px solid rgba(139,32,32,.35);border-radius:4px;color:#e07070;font-family:'DM Sans',sans-serif;font-size:11px;font-weight:700;cursor:pointer;margin-bottom:8px;letter-spacing:.5px;">üîí LOCK APP</button>
    SUMUREZA GENERAL SUPPLIES<br>¬© 2025 ¬∑ Accounting Suite
  </div>
</aside>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <div><div class="ptitle" id="ptitle">Dashboard</div><div class="psub" id="psub">Business overview</div></div>
    <div id="tactions" style="display:flex;gap:9px;align-items:center;"></div>
  </div>
  <div class="content" id="content"></div>
</div>

<!-- SYNC BAR -->
<div class="syncbar" id="syncbar"><span class="spin">‚ü≥</span><span id="syncmsg">Syncing...</span></div>

<!-- FORM MODAL -->
<div class="mbg" id="fmodal">
  <div class="mbox" id="fmodalbox" style="max-width:820px">
    <div class="mtop"><h3 id="fmtitle">Form</h3><button class="mx" onclick="closeFM()">√ó</button></div>
    <div class="mbody" id="fmbody"></div>
    <div class="mfoot" id="fmfoot"></div>
  </div>
</div>

<!-- DOC MODAL -->
<div class="mbg" id="dmodal">
  <div class="mbox" style="max-width:800px">
    <div class="mtop"><h3 id="dmtitle">Document Preview</h3><button class="mx" onclick="closeDM()">√ó</button></div>
    <div id="dmbody"></div>
    <div class="mfoot">
      <button class="btn bout" onclick="closeDM()">‚Üê Close</button>
      <button class="btn bout bsm" onclick="printDoc()">üñ®Ô∏è Print</button>
      <button class="btn bgreen bsm" id="ddrivebtn" onclick="saveDocDrive()" style="display:none">‚òÅÔ∏è Save to Drive</button>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATABASE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DB={
  clients:[],suppliers:[],inventory:[],
  quotations:[],purchase_orders:[],invoices:[],delivery:[],receipts:[],
  income:[],expenses:[],bank_transactions:[],stock_movements:[],
  settings:{
    name:'SUMUREZA GENERAL SUPPLIES',
    tagline:'Quality Supplies, Trusted Service',
    address:'Plot 12, Industrial Area, Kampala, Uganda',
    phone:'+256 700 000000',email:'info@sumureza.co.ug',
    website:'www.sumureza.co.ug',tin:'TIN: 1000000000',
    currency:'UGX',vat:18,
    bank_name:'Stanbic Bank Uganda',
    bank_account:'9030000000001',
    opening_balance:0
  }
};

const DRIVE={
  clientId:localStorage.getItem('sgd_cid')||'',
  apiKey:localStorage.getItem('sgd_akey')||'',
  token:null,folderId:localStorage.getItem('sgd_fid')||'',
  userEmail:null,gapiReady:false,gisReady:false,tokenClient:null,
  fileIds:{}
};
try{Object.assign(DRIVE.fileIds,JSON.parse(localStorage.getItem('sgd_fids')||'{}'));}catch(e){}

let curPage='dashboard';
let docHTML='',docName='';
let editId=null,editKey=null;
let docItems=[];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILITIES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const $=id=>document.getElementById(id);
const esc=s=>String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
const gv=id=>{const e=$(id);return e?e.value:'';}
const today=()=>new Date().toISOString().split('T')[0];
const uid=()=>Date.now().toString(36)+Math.random().toString(36).slice(2,6);
const addDays=d=>{const dt=new Date();dt.setDate(dt.getDate()+d);return dt.toISOString().split('T')[0];}
const fmt=n=>(DB.settings.currency||'UGX')+' '+Number(n||0).toLocaleString('en-UG',{minimumFractionDigits:0});
const fmtN=n=>Number(n||0).toLocaleString('en-UG',{minimumFractionDigits:0});
const daysBetween=(d1,d2)=>Math.floor((new Date(d2)-new Date(d1))/(1000*60*60*24));

let counters=JSON.parse(localStorage.getItem('sgd_ctrs')||'{"QUO":1,"PO":1,"INV":1,"DN":1,"RCP":1}');
const nextRef=p=>{const n=counters[p]++;localStorage.setItem('sgd_ctrs',JSON.stringify(counters));return`${p}-${new Date().getFullYear().toString().slice(2)}-${String(n).padStart(4,'0')}`;}

function toast(msg,type='ok',link){
  document.querySelectorAll('.toast').forEach(t=>t.remove());
  const t=document.createElement('div');t.className='toast';
  t.style.borderColor=type==='err'?'var(--red)':type==='warn'?'var(--gold)':'var(--green)';
  t.innerHTML=esc(msg)+(link?`<br><a href="${link}" target="_blank" style="color:var(--gold-light);font-size:11px;font-weight:600;">üìÇ Open in Drive ‚Üí</a>`:'');
  document.body.appendChild(t);setTimeout(()=>t.remove(),5000);
}
function showSync(m){$('syncbar').classList.add('show');$('syncmsg').textContent=m||'Syncing...';}
function hideSync(){$('syncbar').classList.remove('show');}

function chip(status){
  const map={
    'Active':'cg','Inactive':'cgr','Prospect':'cb2',
    'Paid':'cg','Unpaid':'cr','Partial':'co','Overdue':'cr','Cancelled':'cgr','Void':'cgr',
    'Accepted':'cg','Rejected':'cr','Pending':'co','Expired':'cgr','Converted':'ct',
    'Dispatched':'cb2','Delivered':'cg','Pending Delivery':'co',
    'Received':'cg','Draft':'cgr','Sent':'cb2','Approved':'cg',
    'In Stock':'cg','Low Stock':'co','Out of Stock':'cr',
    'Cleared':'cg','Pending':'co','Bounced':'cr',
  };
  return`<span class="chip ${map[status]||'cgr'}">${esc(status)}</span>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GOOGLE DRIVE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const driveOk=()=>!!(DRIVE.clientId&&DRIVE.apiKey);
const driveCon=()=>!!DRIVE.token;

function updateDriveUI(){
  const dot=$('ddot'),lbl=$('dlbl'),btn=$('dbtn'),ddb=$('ddrivebtn');
  if(!driveOk()){dot.className='dot off';lbl.textContent='Drive not configured';btn.style.display='none';}
  else if(!driveCon()){dot.className='dot warn';lbl.textContent='Click to connect';btn.style.display='block';btn.textContent='üîó Connect';}
  else{dot.className='dot on';lbl.textContent=DRIVE.userEmail||'Drive connected ‚úì';btn.style.display='block';btn.textContent='‚Üª Reconnect';}
  if(ddb)ddb.style.display=driveCon()?'inline-flex':'none';
}

function loadGAPIs(){
  if(!driveOk())return;
  if(!window.gapi){
    const s=document.createElement('script');s.src='https://apis.google.com/js/api.js';
    s.onload=()=>gapi.load('client',async()=>{
      await gapi.client.init({apiKey:DRIVE.apiKey,discoveryDocs:['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']});
      DRIVE.gapiReady=true;tryAuto();
    });document.head.appendChild(s);
  }
  if(!window.google?.accounts){
    const s2=document.createElement('script');s2.src='https://accounts.google.com/gsi/client';
    s2.onload=()=>{
      DRIVE.tokenClient=google.accounts.oauth2.initTokenClient({
        client_id:DRIVE.clientId,scope:'https://www.googleapis.com/auth/drive.file',
        callback:async r=>{
          if(r.error){toast('Auth error: '+r.error,'err');return;}
          DRIVE.token=r.access_token;localStorage.setItem('sgd_tok',r.access_token);
          await getUser();await ensureFolder();await loadAll();
          updateDriveUI();toast('‚úÖ Google Drive connected!');nav(curPage);
        }
      });DRIVE.gisReady=true;tryAuto();
    };document.head.appendChild(s2);
  }
}

function tryAuto(){
  const t=localStorage.getItem('sgd_tok');
  if(t&&DRIVE.gapiReady){DRIVE.token=t;getUser().then(()=>{ensureFolder();loadAll().then(()=>nav(curPage));updateDriveUI();});}
  else updateDriveUI();
}

function driveSignIn(){
  if(!driveOk()){nav('gdrive');return;}
  if(!DRIVE.gisReady||!DRIVE.tokenClient){toast('APIs loading, try again in a moment','warn');return;}
  DRIVE.tokenClient.requestAccessToken({prompt:''});
}

async function getUser(){
  if(!DRIVE.token)return;
  try{const r=await fetch('https://www.googleapis.com/oauth2/v2/userinfo',{headers:{Authorization:'Bearer '+DRIVE.token}});
  const d=await r.json();DRIVE.userEmail=d.email;updateDriveUI();}catch(e){}
}

async function ensureFolder(){
  if(!DRIVE.token||DRIVE.folderId)return;
  try{
    const q=encodeURIComponent(`name='Sumureza Business Data' and mimeType='application/vnd.google-apps.folder' and trashed=false`);
    const r=await fetch(`https://www.googleapis.com/drive/v3/files?q=${q}&fields=files(id)`,{headers:{Authorization:'Bearer '+DRIVE.token}});
    const d=await r.json();
    if(d.files?.length){DRIVE.folderId=d.files[0].id;}
    else{
      const cr=await fetch('https://www.googleapis.com/drive/v3/files',{method:'POST',headers:{Authorization:'Bearer '+DRIVE.token,'Content-Type':'application/json'},body:JSON.stringify({name:'Sumureza Business Data',mimeType:'application/vnd.google-apps.folder'})});
      DRIVE.folderId=(await cr.json()).id;
    }
    localStorage.setItem('sgd_fid',DRIVE.folderId);
  }catch(e){console.warn(e);}
}

async function driveRead(key){
  if(!DRIVE.token)return null;
  try{
    if(!DRIVE.fileIds[key]){
      const q=encodeURIComponent(`name='${key}.json' and '${DRIVE.folderId}' in parents and trashed=false`);
      const r=await fetch(`https://www.googleapis.com/drive/v3/files?q=${q}&fields=files(id)`,{headers:{Authorization:'Bearer '+DRIVE.token}});
      const d=await r.json();
      if(!d.files?.length)return null;
      DRIVE.fileIds[key]=d.files[0].id;localStorage.setItem('sgd_fids',JSON.stringify(DRIVE.fileIds));
    }
    const r2=await fetch(`https://www.googleapis.com/drive/v3/files/${DRIVE.fileIds[key]}?alt=media`,{headers:{Authorization:'Bearer '+DRIVE.token}});
    return await r2.json();
  }catch(e){return null;}
}

async function driveWrite(key,data){
  if(!DRIVE.token)return;
  showSync('Saving to Drive...');
  try{
    const body=JSON.stringify(data,null,2);const fid=DRIVE.fileIds[key];
    let r;
    if(fid){r=await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fid}?uploadType=media`,{method:'PATCH',headers:{Authorization:'Bearer '+DRIVE.token,'Content-Type':'application/json'},body});}
    else{
      const meta={name:key+'.json',mimeType:'application/json',...(DRIVE.folderId?{parents:[DRIVE.folderId]}:{})};
      const form=new FormData();
      form.append('metadata',new Blob([JSON.stringify(meta)],{type:'application/json'}));
      form.append('file',new Blob([body],{type:'application/json'}));
      r=await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id',{method:'POST',headers:{Authorization:'Bearer '+DRIVE.token},body:form});
      const fd=await r.json();DRIVE.fileIds[key]=fd.id;localStorage.setItem('sgd_fids',JSON.stringify(DRIVE.fileIds));
    }
    if(r.status===401){DRIVE.token=null;localStorage.removeItem('sgd_tok');updateDriveUI();toast('Drive session expired. Please reconnect.','warn');}
  }catch(e){console.warn(e);}finally{hideSync();}
}

async function loadAll(){
  if(!DRIVE.token)return;showSync('Loading data from Google Drive...');
  const keys=['clients','suppliers','inventory','quotations','purchase_orders','invoices','delivery','receipts','income','expenses','bank_transactions','stock_movements','settings'];
  for(const k of keys){const d=await driveRead(k);if(d){if(k==='settings')Object.assign(DB.settings,d);else if(Array.isArray(d))DB[k]=d;}}
  hideSync();
}

async function save(key){
  const data=key==='settings'?DB.settings:DB[key];
  localStorage.setItem('sgd_l_'+key,JSON.stringify(data));
  if(driveCon())await driveWrite(key,data);
}

function loadLocal(){
  ['clients','suppliers','inventory','quotations','purchase_orders','invoices','delivery','receipts','income','expenses','bank_transactions','stock_movements'].forEach(k=>{
    try{const d=localStorage.getItem('sgd_l_'+k);if(d)DB[k]=JSON.parse(d);}catch(e){}
  });
  try{const s=localStorage.getItem('sgd_l_settings');if(s)Object.assign(DB.settings,JSON.parse(s));}catch(e){}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const PMETA={
  dashboard:{t:'Dashboard',s:'Business overview'},
  quotations:{t:'Quotations',s:'Manage price quotations sent to clients'},
  purchase_orders:{t:'Purchase Orders',s:'Track orders placed with suppliers'},
  invoices:{t:'Invoices',s:'Track and manage client invoices'},
  delivery:{t:'Delivery Notes',s:'Goods dispatch and delivery records'},
  receipts:{t:'Receipts',s:'Payment receipts issued to clients'},
  income:{t:'Income',s:'All money received by the business'},
  expenses:{t:'Expenses',s:'All business expenditure'},
  bank:{t:'Bank Reconciliation',s:'Match your records against bank statements'},
  pnl:{t:'Profit & Loss',s:'Income vs expenses over a period'},
  balance_sheet:{t:'Balance Sheet',s:'Assets, liabilities and equity'},
  vat:{t:'VAT / Tax Summary',s:'VAT collected and paid ‚Äî Uganda Revenue Authority'},
  aged_debtors:{t:'Aged Debtors',s:'Who owes you and for how long'},
  inventory:{t:'Inventory',s:'Stock management and valuation'},
  clients:{t:'Clients',s:'Client database'},
  suppliers:{t:'Suppliers',s:'Supplier database'},
  settings:{t:'Company Settings',s:'Business information and preferences'},
  pin_management:{t:'PIN Management',s:'Manage staff PINs and access levels'},
};

function nav(page){
  curPage=page;
  document.querySelectorAll('.ni').forEach(el=>el.classList.toggle('active',el.getAttribute('onclick')===`nav('${page}')`));
  const m=PMETA[page]||{t:page,s:''};
  $('ptitle').textContent=m.t;$('psub').textContent=m.s;
  $('tactions').innerHTML='';
  const renders={
    dashboard:renderDash,quotations:()=>renderList('quotations'),
    purchase_orders:()=>renderList('purchase_orders'),
    invoices:()=>renderList('invoices'),delivery:()=>renderList('delivery'),
    receipts:()=>renderList('receipts'),income:()=>renderList('income'),
    expenses:()=>renderList('expenses'),bank:renderBank,
    pnl:renderPnL,balance_sheet:renderBS,vat:renderVAT,aged_debtors:renderAged,
    inventory:renderInventory,clients:()=>renderList('clients'),
    suppliers:()=>renderList('suppliers'),
    settings:renderSettings,gdrive:renderGDrive,pin_management:renderPinMgmt,
  };
  $('content').innerHTML=(renders[page]||renderDash)();
  setTopActions(page);
}

function setTopActions(page){
  const ta=$('tactions');
  const map={
    quotations:['üìã New Quotation',()=>openDocForm('quotation')],
    purchase_orders:['üõí New Purchase Order',()=>openDocForm('purchase_order')],
    invoices:['üßæ New Invoice',()=>openDocForm('invoice')],
    delivery:['üöö New Delivery Note',()=>openDocForm('delivery')],
    receipts:['‚úÖ New Receipt',()=>openDocForm('receipt')],
    income:['+ Record Income',()=>openSimple('income')],
    expenses:['+ Record Expense',()=>openSimple('expenses')],
    bank:['+ Add Transaction',()=>openSimple('bank_transactions')],
    inventory:['+ Add Item',()=>openSimple('inventory')],
    clients:['+ Add Client',()=>openSimple('clients')],
    suppliers:['+ Add Supplier',()=>openSimple('suppliers')],
  };
  if(map[page]){
    const [lbl,fn]=map[page];
    const b=document.createElement('button');b.className='btn bg';b.textContent=lbl;b.onclick=fn;ta.appendChild(b);
  }
  if(driveCon()){
    const sync=document.createElement('button');sync.className='btn bout bsm';sync.innerHTML='‚ü≥ Sync';
    sync.onclick=()=>loadAll().then(()=>{nav(curPage);toast('Data refreshed from Drive ‚úì');});ta.appendChild(sync);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDash(){
  const income=DB.income.reduce((s,r)=>s+(r.amount||0),0);
  const expenses=DB.expenses.reduce((s,r)=>s+(r.amount||0),0);
  const profit=income-expenses;
  const unpaid=DB.invoices.filter(i=>i.status==='Unpaid'||i.status==='Partial').reduce((s,i)=>s+(i.total||0)-(i.paid||0),0);
  const overdue=DB.invoices.filter(i=>(i.status==='Unpaid'||i.status==='Partial')&&i.due&&i.due<today()).length;
  const pendingQ=DB.quotations.filter(q=>q.status==='Pending').length;
  const lowStock=DB.inventory.filter(i=>(i.qty||0)<=(i.reorder||5)).length;
  const vatCollected=DB.invoices.filter(i=>i.applyVat&&i.status!=='Cancelled').reduce((s,i)=>s+(i.vatAmt||0),0);
  const vatPaid=DB.expenses.filter(e=>e.vatAmount).reduce((s,e)=>s+(e.vatAmount||0),0);

  const recent=[
    ...DB.invoices.map(d=>({...d,_t:'invoice'})),
    ...DB.quotations.map(d=>({...d,_t:'quotation'})),
    ...DB.receipts.map(d=>({...d,_t:'receipt'})),
    ...DB.delivery.map(d=>({...d,_t:'delivery'})),
    ...DB.purchase_orders.map(d=>({...d,_t:'purchase_order'})),
  ].sort((a,b)=>(b.date||'').localeCompare(a.date||'')).slice(0,7);

  return`
  <div class="kgrid kg4">
    <div class="kpi kg"><div class="kpi-lbl">Total Income</div><div class="kpi-val">${fmt(income)}</div><div class="kpi-sub">${DB.income.length} transactions</div></div>
    <div class="kpi kr"><div class="kpi-lbl">Total Expenses</div><div class="kpi-val">${fmt(expenses)}</div><div class="kpi-sub">${DB.expenses.length} transactions</div></div>
    <div class="kpi ko"><div class="kpi-lbl">Net Profit</div><div class="kpi-val" style="color:${profit>=0?'#1a6b45':'#8b2020'}">${fmt(profit)}</div><div class="kpi-sub">${profit>=0?'Profitable ‚úì':'Loss ‚ö†'}</div></div>
    <div class="kpi kb"><div class="kpi-lbl">Outstanding</div><div class="kpi-val">${fmt(unpaid)}</div><div class="kpi-sub">${overdue} invoice${overdue!==1?'s':''} overdue</div></div>
    <div class="kpi kp"><div class="kpi-lbl">Pending Quotes</div><div class="kpi-val">${pendingQ}</div><div class="kpi-sub">Awaiting client response</div></div>
    <div class="kpi kt"><div class="kpi-lbl">VAT Collected</div><div class="kpi-val">${fmt(vatCollected)}</div><div class="kpi-sub">VAT paid: ${fmt(vatPaid)}</div></div>
    <div class="kpi kg"><div class="kpi-lbl">Inventory Items</div><div class="kpi-val">${DB.inventory.length}</div><div class="kpi-sub">${lowStock} low/out of stock</div></div>
    <div class="kpi ko"><div class="kpi-lbl">Drive Status</div><div class="kpi-val" style="font-size:16px">${driveCon()?'‚òÅÔ∏è Synced':'‚ö†Ô∏è Local'}</div><div class="kpi-sub">${driveCon()?(DRIVE.userEmail||'Connected'):'Not connected to Drive'}</div></div>
  </div>
  ${overdue>0?`<div class="alert-box alert-err" style="margin-bottom:16px">‚ö†Ô∏è <strong>${overdue} invoice${overdue!==1?'s are':' is'} overdue.</strong> <a onclick="nav('aged_debtors')" style="cursor:pointer;text-decoration:underline">View aged debtors ‚Üí</a></div>`:''}
  ${lowStock>0?`<div class="alert-box alert-warn" style="margin-bottom:16px">üì¶ <strong>${lowStock} inventory item${lowStock!==1?'s are':' is'} low or out of stock.</strong> <a onclick="nav('inventory')" style="cursor:pointer;text-decoration:underline">View inventory ‚Üí</a></div>`:''}
  <div class="card">
    <div class="ch"><h3>üìÑ Recent Activity</h3><button class="btn bout bsm" onclick="nav('invoices')">All invoices ‚Üí</button></div>
    <table class="tbl"><thead><tr><th>Type</th><th>Reference</th><th>Client/Supplier</th><th>Date</th><th>Amount</th><th>Status</th><th>Action</th></tr></thead>
    <tbody>${recent.length?recent.map(d=>`<tr>
      <td>${{invoice:'üßæ Invoice',quotation:'üìã Quote',receipt:'‚úÖ Receipt',delivery:'üöö Delivery',purchase_order:'üõí PO'}[d._t]||d._t}</td>
      <td class="mono">${esc(d.ref||'')}</td>
      <td>${esc(d.client||d.supplier||'')}</td>
      <td>${esc(d.date||'')}</td>
      <td class="mono nr">${fmt(d.total||d.amount||0)}</td>
      <td>${chip(d.status||'')}</td>
      <td><button class="btn bout bxs" onclick="viewDoc('${d._t}','${d.id}')">View</button></td>
    </tr>`).join(''):`<tr class="erow"><td colspan="7">No activity yet ‚Äî start by adding clients and creating invoices</td></tr>`}</tbody>
    </table>
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LIST PAGES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderList(key){
  const cfgs={
    clients:{cols:['Name','Contact','Phone','Email','Status','Actions'],
      row:r=>[esc(r.name),esc(r.contact||''),esc(r.phone||''),esc(r.email||''),chip(r.status||'Active')],
      act:r=>`<button class="btn bout bxs" onclick="openSimple('clients','${r.id}')">Edit</button> <button class="btn bred bxs" onclick="del('clients','${r.id}')">Del</button>`},
    suppliers:{cols:['Name','Contact','Phone','Email','Category','Actions'],
      row:r=>[esc(r.name),esc(r.contact||''),esc(r.phone||''),esc(r.email||''),esc(r.category||''),''],
      act:r=>`<button class="btn bout bxs" onclick="openSimple('suppliers','${r.id}')">Edit</button> <button class="btn bred bxs" onclick="del('suppliers','${r.id}')">Del</button>`},
    quotations:{cols:['Ref','Client','Date','Valid Until','Total','Status','Actions'],
      row:r=>[`<span class="mono">${esc(r.ref)}</span>`,esc(r.client),esc(r.date),esc(r.validUntil||''),`<span class="mono">${fmt(r.total||0)}</span>`,chip(r.status||'Pending')],
      act:r=>`<button class="btn bout bxs" onclick="viewDoc('quotation','${r.id}')">View</button> <button class="btn bout bxs" onclick="openDocForm('quotation','${r.id}')">Edit</button> <button class="btn bgreen bxs" onclick="convertToInvoice('${r.id}')">‚ÜíInvoice</button> <button class="btn bred bxs" onclick="del('quotations','${r.id}')">Del</button>`},
    purchase_orders:{cols:['Ref','Supplier','Date','Expected','Total','Status','Actions'],
      row:r=>[`<span class="mono">${esc(r.ref)}</span>`,esc(r.supplier||''),esc(r.date),esc(r.expected||''),`<span class="mono">${fmt(r.total||0)}</span>`,chip(r.status||'Draft')],
      act:r=>`<button class="btn bout bxs" onclick="viewDoc('purchase_order','${r.id}')">View</button> <button class="btn bout bxs" onclick="openDocForm('purchase_order','${r.id}')">Edit</button> <button class="btn bred bxs" onclick="del('purchase_orders','${r.id}')">Del</button>`},
    invoices:{cols:['Ref','Client','Date','Due','Total','Paid','Balance','Status','Actions'],
      row:r=>{const bal=(r.total||0)-(r.paid||0);return[`<span class="mono">${esc(r.ref)}</span>`,esc(r.client),esc(r.date),esc(r.due||''),`<span class="mono">${fmt(r.total||0)}</span>`,`<span class="mono">${fmt(r.paid||0)}</span>`,`<span class="mono" style="color:${bal>0?'#8b2020':'#1a6b45'}">${fmt(bal)}</span>`,chip(r.status||'Unpaid')];},
      act:r=>`<button class="btn bout bxs" onclick="viewDoc('invoice','${r.id}')">View</button> <button class="btn bout bxs" onclick="openDocForm('invoice','${r.id}')">Edit</button> <button class="btn bgreen bxs" onclick="recordPayment('${r.id}')">üí∞ Pay</button> <button class="btn bred bxs" onclick="del('invoices','${r.id}')">Del</button>`},
    delivery:{cols:['Ref','Client','Date','Items','Status','Actions'],
      row:r=>[`<span class="mono">${esc(r.ref)}</span>`,esc(r.client||''),esc(r.date),r.items?.length||0,chip(r.status||'Dispatched')],
      act:r=>`<button class="btn bout bxs" onclick="viewDoc('delivery','${r.id}')">View</button> <button class="btn bred bxs" onclick="del('delivery','${r.id}')">Del</button>`},
    receipts:{cols:['Ref','Client','Date','Invoice Ref','Amount','Method','Actions'],
      row:r=>[`<span class="mono">${esc(r.ref)}</span>`,esc(r.client||''),esc(r.date),`<span class="mono">${esc(r.invoiceRef||'')}</span>`,`<span class="mono">${fmt(r.amount||0)}</span>`,esc(r.method||'')],
      act:r=>`<button class="btn bout bxs" onclick="viewDoc('receipt','${r.id}')">View</button> <button class="btn bred bxs" onclick="del('receipts','${r.id}')">Del</button>`},
    income:{cols:['Date','Description','Client','Amount','Category','Method','Actions'],
      row:r=>[esc(r.date),esc(r.description||''),esc(r.client||''),`<span class="mono">${fmt(r.amount||0)}</span>`,esc(r.category||''),esc(r.method||'')],
      act:r=>`<button class="btn bout bxs" onclick="openSimple('income','${r.id}')">Edit</button> <button class="btn bred bxs" onclick="del('income','${r.id}')">Del</button>`},
    expenses:{cols:['Date','Description','Vendor','Amount','Category','VAT','Method','Actions'],
      row:r=>[esc(r.date),esc(r.description||''),esc(r.vendor||''),`<span class="mono">${fmt(r.amount||0)}</span>`,esc(r.category||''),r.vatAmount?`<span class="mono">${fmt(r.vatAmount)}</span>`:'‚Äî',esc(r.method||'')],
      act:r=>`<button class="btn bout bxs" onclick="openSimple('expenses','${r.id}')">Edit</button> <button class="btn bred bxs" onclick="del('expenses','${r.id}')">Del</button>`},
  };
  const cfg=cfgs[key];if(!cfg)return'';
  const rows=DB[key]||[];
  return`<div class="card"><div class="ch"><h3>${PMETA[key]?.t||key} <span style="color:var(--ink-muted);font-size:12px;font-family:'DM Sans',sans-serif;font-weight:400">(${rows.length})</span></h3></div>
  <table class="tbl"><thead><tr>${cfg.cols.map(c=>`<th>${c}</th>`).join('')}</tr></thead>
  <tbody>${rows.length?rows.map(r=>`<tr>${cfg.row(r).map(v=>`<td>${v}</td>`).join('')}<td class="nc">${cfg.act(r)}</td></tr>`).join(''):'<tr class="erow"><td colspan="'+cfg.cols.length+'">No records yet</td></tr>'}</tbody>
  </table></div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SIMPLE FORMS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openSimple(key,id){
  const ex=id?DB[key]?.find(r=>r.id===id):null;
  const clist=DB.clients.map(c=>`<option value="${esc(c.name)}">`).join('');
  const slist=DB.suppliers.map(s=>`<option value="${esc(s.name)}">`).join('');
  const payMethods=['Bank Transfer','Mobile Money (MTN)','Mobile Money (Airtel)','Cash','Cheque'].map(m=>`<option ${ex?.method===m?'selected':''}>${m}</option>`).join('');
  const catOpts={
    income:['Service Revenue','Product Sales','Consultation','Commission','Rental','Other'],
    expenses:['Rent','Salaries','Utilities','Internet','Office Supplies','Marketing','Travel','Equipment','Software','Tax','Miscellaneous'],
    inventory:[],
    clients:[],suppliers:[],bank_transactions:['Deposit','Withdrawal','Transfer','Bank Charge','Interest'],
  };

  const forms={
    clients:`<div class="fg2">
      <div class="fg s2"><label class="fl">Company / Client Name *</label><input class="fi" id="f-name" value="${esc(ex?.name||'')}" placeholder="ABC Company Ltd"></div>
      <div class="fg"><label class="fl">Contact Person</label><input class="fi" id="f-contact" value="${esc(ex?.contact||'')}"></div>
      <div class="fg"><label class="fl">Phone</label><input class="fi" id="f-phone" value="${esc(ex?.phone||'')}"></div>
      <div class="fg"><label class="fl">Email</label><input class="fi" id="f-email" value="${esc(ex?.email||'')}"></div>
      <div class="fg"><label class="fl">TIN</label><input class="fi" id="f-tin" value="${esc(ex?.tin||'')}"></div>
      <div class="fg s2"><label class="fl">Address</label><input class="fi" id="f-address" value="${esc(ex?.address||'')}"></div>
      <div class="fg"><label class="fl">Status</label><select class="fs" id="f-status">${['Active','Inactive','Prospect'].map(s=>`<option ${ex?.status===s?'selected':''}>${s}</option>`).join('')}</select></div>
      <div class="fg"><label class="fl">Credit Limit (UGX)</label><input type="number" class="fi" id="f-credit" value="${ex?.credit||0}"></div>
      <div class="fg s2"><label class="fl">Notes</label><input class="fi" id="f-notes" value="${esc(ex?.notes||'')}"></div>
    </div>`,
    suppliers:`<div class="fg2">
      <div class="fg s2"><label class="fl">Supplier Name *</label><input class="fi" id="f-name" value="${esc(ex?.name||'')}" placeholder="Supplier Co. Ltd"></div>
      <div class="fg"><label class="fl">Contact Person</label><input class="fi" id="f-contact" value="${esc(ex?.contact||'')}"></div>
      <div class="fg"><label class="fl">Phone</label><input class="fi" id="f-phone" value="${esc(ex?.phone||'')}"></div>
      <div class="fg"><label class="fl">Email</label><input class="fi" id="f-email" value="${esc(ex?.email||'')}"></div>
      <div class="fg"><label class="fl">Category</label><input class="fi" id="f-category" value="${esc(ex?.category||'')}" placeholder="e.g. Stationery"></div>
      <div class="fg"><label class="fl">TIN</label><input class="fi" id="f-tin" value="${esc(ex?.tin||'')}"></div>
      <div class="fg s2"><label class="fl">Address</label><input class="fi" id="f-address" value="${esc(ex?.address||'')}"></div>
      <div class="fg s2"><label class="fl">Notes</label><input class="fi" id="f-notes" value="${esc(ex?.notes||'')}"></div>
    </div>`,
    income:`<div class="fg2">
      <div class="fg"><label class="fl">Date *</label><input type="date" class="fi" id="f-date" value="${ex?.date||today()}"></div>
      <div class="fg"><label class="fl">Amount (UGX) *</label><input type="number" class="fi" id="f-amount" value="${ex?.amount||''}"></div>
      <div class="fg s2"><label class="fl">Description *</label><input class="fi" id="f-description" value="${esc(ex?.description||'')}"></div>
      <div class="fg"><label class="fl">Client</label><input class="fi" id="f-client" list="cl" value="${esc(ex?.client||'')}"><datalist id="cl">${clist}</datalist></div>
      <div class="fg"><label class="fl">Category</label><select class="fs" id="f-category">${catOpts.income.map(c=>`<option ${ex?.category===c?'selected':''}>${c}</option>`).join('')}</select></div>
      <div class="fg"><label class="fl">Payment Method</label><select class="fs" id="f-method">${payMethods}</select></div>
      <div class="fg"><label class="fl">Invoice/Receipt Ref</label><input class="fi" id="f-ref" value="${esc(ex?.ref||'')}"></div>
    </div>`,
    expenses:`<div class="fg2">
      <div class="fg"><label class="fl">Date *</label><input type="date" class="fi" id="f-date" value="${ex?.date||today()}"></div>
      <div class="fg"><label class="fl">Amount (UGX) *</label><input type="number" class="fi" id="f-amount" value="${ex?.amount||''}"></div>
      <div class="fg s2"><label class="fl">Description *</label><input class="fi" id="f-description" value="${esc(ex?.description||'')}"></div>
      <div class="fg"><label class="fl">Vendor / Payee</label><input class="fi" id="f-vendor" value="${esc(ex?.vendor||'')}" list="sl"><datalist id="sl">${slist}</datalist></div>
      <div class="fg"><label class="fl">Category</label><select class="fs" id="f-category">${catOpts.expenses.map(c=>`<option ${ex?.category===c?'selected':''}>${c}</option>`).join('')}</select></div>
      <div class="fg"><label class="fl">Payment Method</label><select class="fs" id="f-method">${payMethods}</select></div>
      <div class="fg"><label class="fl">VAT Amount (UGX)</label><input type="number" class="fi" id="f-vatamt" value="${ex?.vatAmount||0}" placeholder="0"></div>
      <div class="fg"><label class="fl">Receipt/Ref No.</label><input class="fi" id="f-receiptno" value="${esc(ex?.receiptno||'')}"></div>
      <div class="fg"><label class="fl" style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="f-taxded" ${ex?.taxded?'checked':''}> Tax Deductible</label></div>
    </div>`,
    inventory:`<div class="fg2">
      <div class="fg s2"><label class="fl">Item Name *</label><input class="fi" id="f-name" value="${esc(ex?.name||'')}"></div>
      <div class="fg"><label class="fl">SKU / Code</label><input class="fi" id="f-sku" value="${esc(ex?.sku||'')}"></div>
      <div class="fg"><label class="fl">Category</label><input class="fi" id="f-category" value="${esc(ex?.category||'')}"></div>
      <div class="fg"><label class="fl">Qty in Stock *</label><input type="number" class="fi" id="f-qty" value="${ex?.qty??''}"></div>
      <div class="fg"><label class="fl">Unit</label><select class="fs" id="f-unit">${['pcs','kgs','ltrs','boxes','bags','reams','pairs','sets'].map(u=>`<option ${ex?.unit===u?'selected':''}>${u}</option>`).join('')}</select></div>
      <div class="fg"><label class="fl">Unit Cost (UGX)</label><input type="number" class="fi" id="f-cost" value="${ex?.cost||0}"></div>
      <div class="fg"><label class="fl">Selling Price (UGX)</label><input type="number" class="fi" id="f-price" value="${ex?.price||0}"></div>
      <div class="fg"><label class="fl">Reorder Level</label><input type="number" class="fi" id="f-reorder" value="${ex?.reorder||5}"></div>
      <div class="fg"><label class="fl">Supplier</label><input class="fi" id="f-supplier" value="${esc(ex?.supplier||'')}" list="sl2"><datalist id="sl2">${slist}</datalist></div>
    </div>`,
    bank_transactions:`<div class="fg2">
      <div class="fg"><label class="fl">Date *</label><input type="date" class="fi" id="f-date" value="${ex?.date||today()}"></div>
      <div class="fg"><label class="fl">Type</label><select class="fs" id="f-type">${['Deposit','Withdrawal','Transfer','Bank Charge','Interest'].map(t=>`<option ${ex?.type===t?'selected':''}>${t}</option>`).join('')}</select></div>
      <div class="fg s2"><label class="fl">Description *</label><input class="fi" id="f-description" value="${esc(ex?.description||'')}"></div>
      <div class="fg"><label class="fl">Amount (UGX) *</label><input type="number" class="fi" id="f-amount" value="${ex?.amount||''}"></div>
      <div class="fg"><label class="fl">Reference</label><input class="fi" id="f-ref" value="${esc(ex?.ref||'')}"></div>
      <div class="fg"><label class="fl">Reconciled</label><select class="fs" id="f-reconciled"><option ${ex?.reconciled?'selected':''} value="true">Yes</option><option ${!ex?.reconciled?'selected':''} value="false">No</option></select></div>
    </div>`,
  };

  const titles={clients:'Client',suppliers:'Supplier',income:'Income',expenses:'Expense',inventory:'Inventory Item',bank_transactions:'Bank Transaction'};
  $('fmtitle').textContent=(ex?'Edit ':'New ')+titles[key];
  $('fmbody').innerHTML=forms[key]||'<p>Form unavailable</p>';
  $('fmfoot').innerHTML=`<button class="btn bout" onclick="closeFM()">Cancel</button><button class="btn bg" onclick="saveSimple('${key}','${id||''}')">üíæ Save${driveCon()?' & Sync':''}</button>`;
  $('fmodal').classList.add('open');
}

async function saveSimple(key,id){
  const get={
    clients:()=>({name:gv('f-name'),contact:gv('f-contact'),phone:gv('f-phone'),email:gv('f-email'),tin:gv('f-tin'),address:gv('f-address'),status:gv('f-status'),credit:parseFloat(gv('f-credit'))||0,notes:gv('f-notes')}),
    suppliers:()=>({name:gv('f-name'),contact:gv('f-contact'),phone:gv('f-phone'),email:gv('f-email'),category:gv('f-category'),tin:gv('f-tin'),address:gv('f-address'),notes:gv('f-notes')}),
    income:()=>({date:gv('f-date'),amount:parseFloat(gv('f-amount'))||0,description:gv('f-description'),client:gv('f-client'),category:gv('f-category'),method:gv('f-method'),ref:gv('f-ref')}),
    expenses:()=>({date:gv('f-date'),amount:parseFloat(gv('f-amount'))||0,description:gv('f-description'),vendor:gv('f-vendor'),category:gv('f-category'),method:gv('f-method'),vatAmount:parseFloat(gv('f-vatamt'))||0,receiptno:gv('f-receiptno'),taxded:$('f-taxded')?.checked}),
    inventory:()=>({name:gv('f-name'),sku:gv('f-sku'),category:gv('f-category'),qty:parseFloat(gv('f-qty'))||0,unit:gv('f-unit'),cost:parseFloat(gv('f-cost'))||0,price:parseFloat(gv('f-price'))||0,reorder:parseFloat(gv('f-reorder'))||5,supplier:gv('f-supplier')}),
    bank_transactions:()=>({date:gv('f-date'),type:gv('f-type'),description:gv('f-description'),amount:parseFloat(gv('f-amount'))||0,ref:gv('f-ref'),reconciled:gv('f-reconciled')==='true'}),
  };
  const data=get[key]?.();if(!data)return;
  if(['clients','suppliers','inventory'].includes(key)&&!data.name){toast('Name is required','warn');return;}
  if(['income','expenses','bank_transactions'].includes(key)&&!data.amount){toast('Amount is required','warn');return;}
  if(id){const i=DB[key].findIndex(r=>r.id===id);if(i>-1)DB[key][i]={...DB[key][i],...data};}
  else DB[key].push({id:uid(),createdAt:today(),...data});
  closeFM();await save(key);
  toast(`‚úÖ Saved${driveCon()?' & synced':''}`);nav(key);
}

async function del(key,id){
  if(!confirm('Delete this record? This cannot be undone.'))return;
  DB[key]=DB[key].filter(r=>r.id!==id);
  await save(key);toast('Record deleted');nav(key);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DOCUMENT FORMS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openDocForm(type,id){
  editId=id||null;
  editKey={quotation:'quotations',purchase_order:'purchase_orders',invoice:'invoices',delivery:'delivery',receipt:'receipts'}[type];
  const ex=id?DB[editKey]?.find(r=>r.id===id):null;
  docItems=ex?.items?JSON.parse(JSON.stringify(ex.items)):[{desc:'',qty:1,unit:'pcs',price:0}];
  const isPO=type==='purchase_order',isDel=type==='delivery',isRct=type==='receipt';
  const refPre={quotation:'QUO',purchase_order:'PO',invoice:'INV',delivery:'DN',receipt:'RCP'}[type];
  const ref=ex?.ref||nextRef(refPre);
  const clist=DB.clients.map(c=>`<option value="${esc(c.name)}">`).join('');
  const slist=DB.suppliers.map(s=>`<option value="${esc(s.name)}">`).join('');
  const payM=['Bank Transfer','Mobile Money (MTN)','Mobile Money (Airtel)','Cash','Cheque'].map(m=>`<option ${ex?.method===m?'selected':''}>${m}</option>`).join('');

  const extras={
    quotation:`<div class="fg"><label class="fl">Valid Until</label><input type="date" class="fi" id="f-validUntil" value="${ex?.validUntil||addDays(30)}"></div>`,
    purchase_order:`<div class="fg"><label class="fl">Expected Delivery</label><input type="date" class="fi" id="f-expected" value="${ex?.expected||addDays(14)}"></div>
      <div class="fg"><label class="fl">Status</label><select class="fs" id="f-status">${['Draft','Sent','Approved','Received'].map(s=>`<option ${ex?.status===s?'selected':''}>${s}</option>`).join('')}</select></div>`,
    invoice:`<div class="fg"><label class="fl">Due Date</label><input type="date" class="fi" id="f-due" value="${ex?.due||addDays(14)}"></div>
      <div class="fg"><label class="fl">Payment Method</label><select class="fs" id="f-method">${payM}</select></div>
      <div class="fg"><label class="fl">Amount Paid (UGX)</label><input type="number" class="fi" id="f-paid" value="${ex?.paid||0}" oninput="calcTotals()"></div>`,
    delivery:`<div class="fg"><label class="fl">Delivery Address</label><input class="fi" id="f-delivAddr" value="${esc(ex?.delivAddr||'')}"></div>
      <div class="fg"><label class="fl">Status</label><select class="fs" id="f-status">${['Dispatched','Delivered','Pending Delivery'].map(s=>`<option ${ex?.status===s?'selected':''}>${s}</option>`).join('')}</select></div>`,
    receipt:`<div class="fg"><label class="fl">Invoice Ref</label><input class="fi" id="f-invoiceRef" value="${esc(ex?.invoiceRef||'')}"></div>
      <div class="fg"><label class="fl">Amount Received (UGX)</label><input type="number" class="fi" id="f-paid" value="${ex?.paid||ex?.amount||0}"></div>
      <div class="fg"><label class="fl">Balance Remaining</label><input type="number" class="fi" id="f-balance" value="${ex?.balance||0}"></div>
      <div class="fg"><label class="fl">Payment Method</label><select class="fs" id="f-method">${payM}</select></div>`,
  }[type]||'';

  const typeLabel={quotation:'üìã Quotation',purchase_order:'üõí Purchase Order',invoice:'üßæ Invoice',delivery:'üöö Delivery Note',receipt:'‚úÖ Receipt'}[type];
  const partyLabel=isPO?'Supplier':'Client';
  const partyList=isPO?slist:clist;
  const partyId=isPO?'f-supplier':'f-client';
  const partyVal=ex?(isPO?ex.supplier:ex.client)||'':'';

  $('fmtitle').textContent=(ex?'Edit ':'New ')+typeLabel;
  $('fmodalbox').style.maxWidth='860px';
  $('fmbody').innerHTML=`
    <div class="fg2" style="margin-bottom:16px">
      <div class="fg"><label class="fl">Reference No.</label><input class="fi" id="f-ref" value="${esc(ref)}"></div>
      <div class="fg"><label class="fl">Date</label><input type="date" class="fi" id="f-date" value="${ex?.date||today()}"></div>
      <div class="fg"><label class="fl">${partyLabel} *</label><input class="fi" id="${partyId}" list="pl" value="${esc(partyVal)}" placeholder="Type or select"><datalist id="pl">${partyList}</datalist></div>
      <div class="fg"><label class="fl">${partyLabel} Address</label><input class="fi" id="f-addr" value="${esc(ex?.addr||'')}"></div>
      ${extras}
      <div class="fg s2"><label class="fl">Notes</label><textarea class="ft" id="f-notes" style="min-height:52px">${esc(ex?.notes||defNotes(type))}</textarea></div>
    </div>
    ${isRct?'':`
    <div style="font-size:10.5px;font-weight:700;color:var(--ink-soft);letter-spacing:.4px;text-transform:uppercase;margin-bottom:7px">Line Items</div>
    <div style="overflow-x:auto;border:1px solid var(--border);border-radius:6px 6px 0 0">
    <table class="itbl"><thead><tr>
      <th style="width:26px">#</th><th>Description</th>
      <th style="width:65px">Qty</th><th style="width:65px">Unit</th>
      ${!isDel?'<th style="width:115px">Unit Price</th><th style="width:105px;text-align:right">Amount</th>':''}
      <th style="width:34px"></th>
    </tr></thead><tbody id="ditbody"></tbody></table></div>
    <button class="add-row" onclick="addDI()">+ Add Line Item</button>
    ${!isDel?`<div class="twrap"><div class="tbox">
      <div class="trow"><span class="tl">Subtotal</span><span class="tv" id="t-sub">0</span></div>
      <div class="trow"><span class="tl">Discount (%)</span><input type="number" class="disc-in" id="t-disc" value="${ex?.discount||0}" min="0" max="100" oninput="calcTotals()"></div>
      <div class="trow"><span class="tl">After Discount</span><span class="tv" id="t-after">0</span></div>
      <div class="trow"><span class="tl">VAT (${DB.settings.vat||18}%) <input type="checkbox" id="t-vat" ${ex?.applyVat?'checked':''} onchange="calcTotals()" style="margin-left:5px"></span><span class="tv" id="t-vatamt">0</span></div>
      <div class="trow grand"><span class="tl">TOTAL</span><span class="tv" id="t-total">0</span></div>
    </div></div>`:''}
    `}
  `;
  $('fmfoot').innerHTML=`
    <button class="btn bout" onclick="closeFM()">Cancel</button>
    <button class="btn bout bsm" onclick="previewDocForm('${type}')">üëÅ Preview</button>
    <button class="btn bg" onclick="saveDocForm('${type}')">üíæ Save${driveCon()?' & Sync':''}</button>`;
  $('fmodal').classList.add('open');
  renderDI(isDel,isPO);calcTotals();
}

function defNotes(t){
  return{quotation:'This quotation is valid for 30 days. Prices subject to change after expiry.',
    purchase_order:'Please deliver to our premises. Contact us before delivery.',
    invoice:'Please make payment within 14 days. Thank you for your business.',
    delivery:'Please inspect goods on delivery. Report discrepancies within 24 hours.',
    receipt:'This is an official receipt. Please keep for your records.'}[t]||'';
}

function renderDI(isDel,isPO){
  const b=$('ditbody');if(!b)return;
  // Build inventory datalist
  const invOpts=DB.inventory.map(it=>`<option value="${esc(it.name)}" data-id="${it.id}" data-price="${isPO?it.cost:it.price}" data-unit="${it.unit}" data-qty="${it.qty}">`).join('');
  b.innerHTML=docItems.map((it,i)=>{
    const invItem=it.invId?DB.inventory.find(x=>x.id===it.invId):null;
    const stockInfo=invItem?`<span style="font-size:9.5px;color:${invItem.qty<=invItem.reorder?'#8b2020':'#1a6b45'};font-weight:700"> (Stock: ${invItem.qty} ${invItem.unit})</span>`:'';
    return`<tr>
    <td style="color:var(--ink-muted);font-size:10px;text-align:center">${i+1}</td>
    <td style="min-width:180px">
      <input value="${esc(it.desc)}" placeholder="Type or pick from inventory‚Ä¶" list="invlist${i}" oninput="updDI(${i},'desc',this.value)" onchange="pickInvItem(${i},this.value,${isPO?'true':'false'})">
      <datalist id="invlist${i}">${invOpts}</datalist>
      ${stockInfo}
    </td>
    <td><input type="number" value="${it.qty||1}" min="0" style="text-align:center;width:60px" oninput="updDI(${i},'qty',this.value)"></td>
    <td><select style="width:60px" oninput="updDI(${i},'unit',this.value)">${['pcs','kgs','ltrs','boxes','bags','reams','hrs','days','sets','pairs'].map(u=>`<option ${(it.unit||'pcs')===u?'selected':''}>${u}</option>`).join('')}</select></td>
    ${!isDel?`<td><input type="number" value="${it.price||0}" min="0" style="text-align:right;width:100px" oninput="updDI(${i},'price',this.value)"></td>
    <td class="ac">${(it.qty&&it.price)?fmtN(it.qty*it.price):'‚Äî'}</td>`:''}
    <td><button class="delbtn" onclick="remDI(${i})">√ó</button></td>
  </tr>`}).join('');
}

function pickInvItem(i,name,isCost){
  const invItem=DB.inventory.find(x=>x.name===name);
  if(!invItem)return;
  docItems[i].desc=invItem.name;
  docItems[i].price=isCost?(invItem.cost||0):(invItem.price||0);
  docItems[i].unit=invItem.unit||'pcs';
  docItems[i].invId=invItem.id;
  // Low stock warning
  if(!isCost&&invItem.qty<=(invItem.reorder||5)){
    toast(`‚ö†Ô∏è Low stock: ${invItem.name} ‚Äî only ${invItem.qty} ${invItem.unit} remaining`,'warn');
  }
  const isDel=!$('t-sub');
  renderDI(isDel,isCost);calcTotals();
}

function updDI(i,f,v){
  docItems[i][f]=f==='desc'||f==='unit'?v:parseFloat(v)||0;
  if(f==='desc'&&docItems[i].invId){
    const inv=DB.inventory.find(x=>x.name===v);
    if(!inv)docItems[i].invId=null; // cleared
  }
  calcTotals();
  const rows=document.querySelectorAll('#ditbody tr');
  if(rows[i]){const ac=rows[i].querySelector('.ac');if(ac){const it=docItems[i];ac.textContent=(it.qty&&it.price)?fmtN(it.qty*it.price):'‚Äî';}}
}
function addDI(){
  docItems.push({desc:'',qty:1,unit:'pcs',price:0});
  const isPO=!!document.querySelector('#f-supplier');
  const isDel=!$('t-sub');
  renderDI(isDel,isPO);calcTotals();
}
function remDI(i){
  if(docItems.length===1)return;
  docItems.splice(i,1);
  const isPO=!!document.querySelector('#f-supplier');
  const isDel=!$('t-sub');
  renderDI(isDel,isPO);calcTotals();
}

function calcTotals(){
  const sub=docItems.reduce((s,it)=>s+(it.qty*it.price),0);
  const d=parseFloat($('t-disc')?.value||0);
  const after=sub-sub*d/100;
  const vp=DB.settings.vat||18;
  const av=$('t-vat')?.checked;
  const va=av?after*vp/100:0;
  const tot=after+va;
  if($('t-sub'))$('t-sub').textContent=fmt(sub);
  if($('t-after'))$('t-after').textContent=fmt(after);
  if($('t-vatamt'))$('t-vatamt').textContent=fmt(va);
  if($('t-total'))$('t-total').textContent=fmt(tot);
  return{sub,d,after,va,tot,av};
}

async function saveDocForm(type){
  const key={quotation:'quotations',purchase_order:'purchase_orders',invoice:'invoices',delivery:'delivery',receipt:'receipts'}[type];
  const isPO=type==='purchase_order',isDel=type==='delivery',isRct=type==='receipt';
  const t=!isDel&&!isRct?calcTotals():{};
  const paid=parseFloat(gv('f-paid'))||0;
  const newStatus=isPO?gv('f-status')||'Draft':null;

  const base={id:editId||uid(),ref:gv('f-ref'),date:gv('f-date'),notes:gv('f-notes'),createdAt:today(),
    ...(isPO?{supplier:gv('f-supplier'),addr:gv('f-addr')}:{client:gv('f-client'),addr:gv('f-addr')})};

  const extra={
    quotation:{validUntil:gv('f-validUntil'),items:docItems,discount:parseFloat(gv('t-disc'))||0,applyVat:$('t-vat')?.checked,sub:t.sub,vatAmt:t.va,total:t.tot,status:editId?DB[key]?.find(r=>r.id===editId)?.status||'Pending':'Pending'},
    purchase_order:{expected:gv('f-expected'),status:newStatus,items:docItems,discount:parseFloat(gv('t-disc'))||0,applyVat:$('t-vat')?.checked,sub:t.sub,vatAmt:t.va,total:t.tot},
    invoice:{due:gv('f-due'),method:gv('f-method'),paid,items:docItems,discount:parseFloat(gv('t-disc'))||0,applyVat:$('t-vat')?.checked,sub:t.sub,vatAmt:t.va,total:t.tot,status:paid<=0?'Unpaid':(paid<t.tot?'Partial':'Paid')},
    delivery:{delivAddr:gv('f-delivAddr'),status:gv('f-status')||'Dispatched',items:docItems},
    receipt:{invoiceRef:gv('f-invoiceRef'),paid,amount:paid,balance:parseFloat(gv('f-balance'))||0,total:paid,method:gv('f-method'),status:'Received'},
  }[type];

  const rec={...base,...extra};

  // ‚îÄ‚îÄ STOCK MOVEMENT LOGIC ‚îÄ‚îÄ
  // DELIVERY: reduce stock for each line item
  if(isDel&&!editId){
    const movements=[];
    for(const it of docItems){
      if(!it.desc||!it.qty)continue;
      const invItem=DB.inventory.find(x=>x.id===it.invId||x.name===it.desc);
      if(invItem){
        const before=invItem.qty;
        invItem.qty=Math.max(0,invItem.qty-(it.qty||0));
        movements.push({item:invItem.name,before,after:invItem.qty,qty:it.qty,unit:it.unit||invItem.unit});
        logStockMovement('OUT',invItem,it.qty,rec.ref,'Sale/Delivery');
      }
    }
    if(movements.length){
      await save('inventory');
      const warns=movements.filter(m=>m.after<=(DB.inventory.find(x=>x.name===m.item)?.reorder||5));
      if(warns.length)toast(`üì¶ Stock reduced. ‚ö†Ô∏è ${warns.length} item(s) now low/out of stock!`,'warn');
      else toast(`üì¶ Stock updated for ${movements.length} item(s)`);
    }
  }

  // PURCHASE ORDER marked as RECEIVED: increase stock
  if(isPO&&newStatus==='Received'){
    const oldRec=editId?DB.purchase_orders.find(r=>r.id===editId):null;
    const wasReceived=oldRec?.status==='Received';
    if(!wasReceived){
      for(const it of docItems){
        if(!it.desc||!it.qty)continue;
        const invItem=DB.inventory.find(x=>x.id===it.invId||x.name===it.desc);
        if(invItem){
          invItem.qty=(invItem.qty||0)+(it.qty||0);
          logStockMovement('IN',invItem,it.qty,rec.ref,'Purchase/Restock');
        } else {
          // Auto-create inventory item if it doesn't exist
          const newItem={id:uid(),name:it.desc,qty:it.qty||0,unit:it.unit||'pcs',cost:it.price||0,price:it.price||0,reorder:5,supplier:rec.supplier,createdAt:today(),sku:'',category:''};
          DB.inventory.push(newItem);
          logStockMovement('IN',newItem,it.qty,rec.ref,'Purchase/Restock - New Item');
        }
      }
      await save('inventory');
      toast(`üì¶ Stock updated ‚Äî ${docItems.filter(i=>i.qty).length} item(s) restocked from ${rec.ref}`);
    }
  }

  if(editId){const i=DB[key].findIndex(r=>r.id===editId);if(i>-1)DB[key][i]=rec;}
  else DB[key].push(rec);
  closeFM();await save(key);
  if(!isDel&&!(isPO&&newStatus==='Received'))toast(`‚úÖ Saved${driveCon()?' & synced':''}!`);
  nav(key);
}

function convertToInvoice(qId){
  const q=DB.quotations.find(r=>r.id===qId);if(!q)return;
  if(!confirm(`Convert "${q.ref}" to an Invoice?`))return;
  const inv={id:uid(),ref:nextRef('INV'),date:today(),client:q.client,addr:q.addr,notes:q.notes,
    items:q.items,discount:q.discount||0,applyVat:q.applyVat,sub:q.sub,vatAmt:q.vatAmt,total:q.total,
    due:addDays(14),paid:0,status:'Unpaid',createdAt:today(),fromQuote:q.ref};
  DB.invoices.push(inv);
  q.status='Converted';
  save('invoices');save('quotations');
  toast(`‚úÖ Invoice ${inv.ref} created from ${q.ref}`);nav('invoices');
}

function recordPayment(invId){
  const inv=DB.invoices.find(r=>r.id===invId);if(!inv)return;
  const bal=(inv.total||0)-(inv.paid||0);
  $('fmtitle').textContent='Record Payment ‚Äî '+inv.ref;
  $('fmodalbox').style.maxWidth='460px';
  $('fmbody').innerHTML=`<div class="fg2">
    <div class="fg s2" style="background:var(--gold-pale);padding:12px;border-radius:var(--r);margin-bottom:4px">
      <div style="font-size:13px"><strong>${esc(inv.client)}</strong> ¬∑ ${esc(inv.ref)}</div>
      <div style="font-size:12px;color:var(--ink-soft);margin-top:4px">Total: ${fmt(inv.total)} &nbsp;|&nbsp; Paid: ${fmt(inv.paid||0)} &nbsp;|&nbsp; Balance: <strong style="color:var(--red)">${fmt(bal)}</strong></div>
    </div>
    <div class="fg"><label class="fl">Date</label><input type="date" class="fi" id="p-date" value="${today()}"></div>
    <div class="fg"><label class="fl">Amount Received (UGX)</label><input type="number" class="fi" id="p-amount" value="${bal}" min="0" max="${bal}"></div>
    <div class="fg"><label class="fl">Payment Method</label><select class="fs" id="p-method">${['Bank Transfer','Mobile Money (MTN)','Mobile Money (Airtel)','Cash','Cheque'].map(m=>`<option>${m}</option>`).join('')}</select></div>
    <div class="fg"><label class="fl">Reference/Notes</label><input class="fi" id="p-note" placeholder="e.g. Transaction ID"></div>
  </div>`;
  $('fmfoot').innerHTML=`<button class="btn bout" onclick="closeFM()">Cancel</button><button class="btn bgreen" onclick="applyPayment('${invId}')">‚úÖ Record Payment</button>`;
  $('fmodal').classList.add('open');
}

async function applyPayment(invId){
  const inv=DB.invoices.find(r=>r.id===invId);if(!inv)return;
  const amt=parseFloat(gv('p-amount'))||0;if(amt<=0){toast('Enter a valid amount','warn');return;}
  const newPaid=(inv.paid||0)+amt;
  inv.paid=newPaid;
  inv.status=newPaid<=0?'Unpaid':(newPaid<inv.total?'Partial':'Paid');
  // auto-create receipt
  const rct={id:uid(),ref:nextRef('RCP'),date:gv('p-date'),client:inv.client,invoiceRef:inv.ref,
    paid:amt,amount:amt,balance:Math.max(0,(inv.total||0)-newPaid),total:amt,
    method:gv('p-method'),notes:gv('p-note'),status:'Received',createdAt:today()};
  DB.receipts.push(rct);
  // auto-create income record
  DB.income.push({id:uid(),date:gv('p-date'),amount:amt,description:`Payment for ${inv.ref}`,
    client:inv.client,category:'Service Revenue',method:gv('p-method'),ref:inv.ref,createdAt:today()});
  closeFM();
  await save('invoices');await save('receipts');await save('income');
  toast(`‚úÖ Payment of ${fmt(amt)} recorded. Receipt ${rct.ref} created.`);nav('invoices');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DOCUMENT PREVIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function viewDoc(type,id){
  const key={quotation:'quotations',purchase_order:'purchase_orders',invoice:'invoices',delivery:'delivery',receipt:'receipts'}[type];
  const rec=DB[key]?.find(r=>r.id===id);if(!rec){toast('Not found','err');return;}
  docHTML=buildDoc(type,rec);docName=`${rec.ref} ‚Äî ${rec.client||rec.supplier||''}`;
  $('dmtitle').textContent=`Preview ‚Äî ${rec.ref}`;
  $('dmbody').innerHTML=docHTML;
  $('ddrivebtn').style.display=driveCon()?'inline-flex':'none';
  $('dmodal').classList.add('open');
}

function previewDocForm(type){
  const t=!(['delivery','receipt'].includes(type))?calcTotals():{};
  const isPO=type==='purchase_order';
  const fakeRec={ref:gv('f-ref'),date:gv('f-date'),client:!isPO?gv('f-client'):'',supplier:isPO?gv('f-supplier'):'',
    addr:gv('f-addr'),notes:gv('f-notes'),items:docItems,total:t.tot||0,sub:t.sub||0,vatAmt:t.va||0,
    discount:parseFloat(gv('t-disc'))||0,applyVat:$('t-vat')?.checked,
    validUntil:gv('f-validUntil'),due:gv('f-due'),expected:gv('f-expected'),
    paid:parseFloat(gv('f-paid'))||0,balance:parseFloat(gv('f-balance'))||0,
    invoiceRef:gv('f-invoiceRef'),method:gv('f-method'),delivAddr:gv('f-delivAddr'),status:gv('f-status')};
  docHTML=buildDoc(type,fakeRec);docName=`${fakeRec.ref} Preview`;
  $('dmtitle').textContent='Preview ‚Äî '+fakeRec.ref;
  $('dmbody').innerHTML=docHTML;
  $('ddrivebtn').style.display=driveCon()?'inline-flex':'none';
  $('dmodal').classList.add('open');
}

function buildDoc(type,r){
  const co=DB.settings;
  const isPO=type==='purchase_order',isDel=type==='delivery',isRct=type==='receipt';
  const names={quotation:'QUOTATION',purchase_order:'PURCHASE ORDER',invoice:'INVOICE',delivery:'DELIVERY NOTE',receipt:'RECEIPT'};
  const colors={quotation:'#1a3a6b',purchase_order:'#4a1a6b',invoice:'#1a6b45',delivery:'#0d6b6b',receipt:'#8b2020'};
  let meta2='';
  if(type==='quotation')meta2=`<div class="dmeta">Valid Until: ${r.validUntil||''}</div>`;
  if(type==='invoice')meta2=`<div class="dmeta">Due Date: ${r.due||''}</div>`;
  if(type==='purchase_order')meta2=`<div class="dmeta">Expected: ${r.expected||''}</div>`;

  let body='';
  if(isRct){
    body=`<div style="background:#fdf6e3;border:2px solid #c8962a;border-radius:6px;padding:16px 20px;margin-bottom:20px">
      <div style="font-size:9px;letter-spacing:2px;text-transform:uppercase;color:#c8962a;font-weight:700">Amount Received</div>
      <div style="font-family:'Playfair Display',serif;font-size:24px;font-weight:900;color:#1a6b45;margin:5px 0">${fmt(r.paid||r.amount||0)}</div>
      <div style="font-size:11px;color:#3a4a5a;line-height:1.8">
        <strong>Method:</strong> ${r.method||'‚Äî'}<br>
        ${r.invoiceRef?`<strong>Invoice:</strong> ${r.invoiceRef}<br>`:''}
        <strong>Balance:</strong> ${(r.balance||0)>0?fmt(r.balance):'NIL ‚Äî Fully Paid ‚úì'}
      </div></div>`;
  } else {
    const cols=isDel
      ?`<th>Description</th><th class="c">Qty</th><th class="c">Unit</th><th>Condition</th>`
      :`<th>Description</th><th class="c">Qty</th><th class="c">Unit</th><th class="r">Unit Price</th><th class="r">Amount (${co.currency||'UGX'})</th>`;
    const rows=(r.items||[]).map((it,i)=>isDel
      ?`<tr><td>${i+1}. ${esc(it.desc)||'‚Äî'}</td><td class="c">${it.qty}</td><td class="c">${it.unit}</td><td>Good</td></tr>`
      :`<tr><td>${i+1}. ${esc(it.desc)||'‚Äî'}</td><td class="c">${it.qty}</td><td class="c">${it.unit}</td><td class="r">${fmtN(it.price||0)}</td><td class="r">${fmtN((it.qty||0)*(it.price||0))}</td></tr>`
    ).join('');
    body=`<table class="dtable"><thead><tr>${cols}</tr></thead><tbody>${rows}</tbody></table>`;
    if(!isDel){
      body+=`<div style="display:flex;justify-content:flex-end;margin-bottom:24px"><div class="dtrbox">
        <div class="dtr"><span>Subtotal</span><span>${fmt(r.sub||0)}</span></div>
        ${(r.discount||0)>0?`<div class="dtr"><span>Discount (${r.discount}%)</span><span>- ${fmt((r.sub||0)*r.discount/100)}</span></div>`:''}
        ${r.applyVat?`<div class="dtr"><span>VAT (${co.vat||18}%)</span><span>${fmt(r.vatAmt||0)}</span></div>`:''}
        <div class="dtr grand"><span>TOTAL DUE</span><span>${fmt(r.total||0)}</span></div>
      </div></div>`;
      if(type==='invoice'&&(r.paid||0)>0){
        const bal=(r.total||0)-(r.paid||0);
        body+=`<div style="display:flex;justify-content:flex-end;margin-bottom:14px"><div class="dtrbox">
          <div class="dtr"><span>Amount Paid</span><span style="color:#1a6b45;font-weight:700">${fmt(r.paid)}</span></div>
          <div class="dtr"><span>Balance Due</span><span style="color:${bal>0?'#8b2020':'#1a6b45'};font-weight:700">${fmt(bal)}</span></div>
        </div></div>`;
      }
    }
  }
  if(type==='invoice'&&r.method){
    body+=`<div class="dnote" style="margin-bottom:16px"><strong>Payment to:</strong> ${esc(co.bank_name)} | A/C: ${esc(co.bank_account)} | Method: ${esc(r.method)}</div>`;
  }
  const sig1=isRct?'Cashier / Authorized':isPO?'Ordered By':'Prepared By';
  const sig2=isDel?'Received By (Client Signature)':isRct?'Received By':'Authorized Signature';
  const fromLabel=isPO?'Purchase From':'Bill To / Deliver To';
  const fromName=r.supplier||r.client||'‚Äî';
  return`<div class="docpaper">
    <div class="dh">
      <div class="dco">
        <h2 style="font-family:'Playfair Display',serif;font-size:20px;font-weight:900">${esc(co.name)}</h2>
        <div class="dtl">${esc(co.tagline)}</div>
        <div class="dci">üìç ${esc(co.address)}<br>üìû ${esc(co.phone)} &nbsp;‚úâÔ∏è ${esc(co.email)}<br>üåê ${esc(co.website)} &nbsp;${esc(co.tin)}</div>
      </div>
      <div>
        <div class="dtn" style="color:${colors[type]||'#0f1923'}">${names[type]}</div>
        <div class="dref">${esc(r.ref||'')}</div>
        <div class="dmeta">Date: ${r.date||''}</div>${meta2}
      </div>
    </div>
    <div class="dpar">
      <div class="dp2"><h4>From</h4><div class="dpn">${esc(co.name)}</div><p>${esc(co.address)}<br>${esc(co.phone)}<br>${esc(co.email)}</p></div>
      <div class="dp2"><h4>${fromLabel}</h4><div class="dpn">${esc(fromName)}</div><p>${esc(r.addr||'')}</p></div>
    </div>
    ${body}
    ${r.notes?`<div class="dnote"><strong>Notes:</strong> ${esc(r.notes)}</div>`:''}
    <div class="dfooter">
      <div class="sig"><div class="sigline"></div><div class="siglbl">${sig1}</div></div>
      <div style="text-align:center;font-size:9.5px;color:#aaa"><div style="color:#c8962a;font-weight:700;font-size:10.5px;margin-bottom:3px">${esc(co.name)}</div>Thank you for your business!<br>${esc(co.website)}</div>
      <div class="sig"><div class="sigline"></div><div class="siglbl">${sig2}</div></div>
    </div>
  </div>`;
}

function printDoc(){
  const w=window.open('','_blank');
  w.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet"><style>body{margin:0;padding:0;}*{box-sizing:border-box;}${getDocCSS()}</style></head><body>${docHTML}</body></html>`);
  w.document.close();setTimeout(()=>w.print(),600);
}
function getDocCSS(){return`.docpaper{padding:36px 44px;font-family:'DM Sans',sans-serif;color:#0f1923;}.dh{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:28px;padding-bottom:20px;border-bottom:3px solid #0f1923;position:relative;}.dh::after{content:'';position:absolute;bottom:-6px;left:0;right:0;height:1.5px;background:#c8962a;}.dco h2{font-family:'Playfair Display',serif;font-size:19px;font-weight:900;}.dtl{font-size:9px;color:#c8962a;letter-spacing:2px;text-transform:uppercase;margin-top:2px;font-weight:700;}.dci{margin-top:8px;font-size:10px;color:#3a4a5a;line-height:1.7;}.dtn{font-family:'Playfair Display',serif;font-size:24px;font-weight:900;text-align:right;}.dref{font-family:'DM Mono',monospace;font-size:11px;color:#7a8a9a;text-align:right;margin-top:3px;}.dmeta{font-size:10px;color:#7a8a9a;text-align:right;margin-top:2px;}.dpar{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:22px;}.dp2 h4{font-size:8px;letter-spacing:2px;text-transform:uppercase;color:#c8962a;font-weight:700;margin-bottom:4px;}.dp2 .dpn{font-family:'Playfair Display',serif;font-size:13px;font-weight:700;}.dp2 p{font-size:10px;color:#3a4a5a;line-height:1.7;}.dtable{width:100%;border-collapse:collapse;margin-bottom:6px;}.dtable thead th{background:#0f1923;color:#fff;font-size:8px;letter-spacing:1px;text-transform:uppercase;padding:7px 10px;font-weight:600;text-align:left;}.dtable thead th.r{text-align:right;}.dtable thead th.c{text-align:center;}.dtable tbody tr{border-bottom:1px solid #e8e4dc;}.dtable tbody tr:nth-child(even){background:#faf8f4;}.dtable td{padding:7px 10px;font-size:11px;}.dtable td.r{text-align:right;font-family:'DM Mono',monospace;}.dtable td.c{text-align:center;}.dtrbox{min-width:240px;}.dtr{display:flex;justify-content:space-between;padding:5px 0;font-size:11.5px;border-bottom:1px dashed #e8e4dc;}.dtr:last-child{border:none;}.dtr.grand{font-weight:700;font-size:13px;padding:8px 12px;background:#0f1923;color:#fff;border-radius:4px;margin-top:4px;border:none;}.dtr.grand span:last-child{color:#f0c96a;font-family:'DM Mono',monospace;}.dnote{font-size:10px;color:#3a4a5a;padding:9px 13px;border-left:3px solid #c8962a;background:#fdf6e3;border-radius:0 4px 4px 0;margin-bottom:20px;}.dfooter{border-top:2px solid #0f1923;padding-top:14px;display:flex;justify-content:space-between;}.sig{text-align:center;}.sigline{width:110px;border-bottom:1px solid #0f1923;margin:0 auto 4px;padding-bottom:22px;}.siglbl{font-size:9px;color:#7a8a9a;}`;}

async function saveDocDrive(){
  if(!driveCon()){toast('Connect Drive first','warn');return;}
  const btn=$('ddrivebtn');btn.innerHTML='‚è≥...';btn.disabled=true;
  try{
    await ensureFolder();
    const filename=docName.replace(/[^a-zA-Z0-9\s\-]/g,'')+'.html';
    const full=`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${filename}</title><link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet"><style>body{margin:0;}${getDocCSS()}</style></head><body>${docHTML}</body></html>`;
    const meta={name:filename,mimeType:'text/html',...(DRIVE.folderId?{parents:[DRIVE.folderId]}:{})};
    const form=new FormData();
    form.append('metadata',new Blob([JSON.stringify(meta)],{type:'application/json'}));
    form.append('file',new Blob([full],{type:'text/html'}));
    const r=await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,webViewLink',{method:'POST',headers:{Authorization:'Bearer '+DRIVE.token},body:form});
    if(r.status===401){DRIVE.token=null;localStorage.removeItem('sgd_tok');updateDriveUI();toast('Session expired','warn');btn.innerHTML='‚òÅÔ∏è Save to Drive';btn.disabled=false;return;}
    const f=await r.json();
    btn.innerHTML='‚úÖ Saved!';setTimeout(()=>{btn.innerHTML='‚òÅÔ∏è Save to Drive';btn.disabled=false;},2500);
    toast('‚òÅÔ∏è Document saved to Drive!','ok',f.webViewLink);
  }catch(e){toast('Upload failed: '+e.message,'err');btn.innerHTML='‚òÅÔ∏è Save to Drive';btn.disabled=false;}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BANK RECONCILIATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderBank(){
  const txns=DB.bank_transactions.sort((a,b)=>a.date?.localeCompare(b.date));
  let bal=DB.settings.opening_balance||0;
  const rows=txns.map(t=>{
    const isIn=['Deposit','Interest'].includes(t.type);
    if(isIn)bal+=t.amount||0;else bal-=t.amount||0;
    return`<tr>
      <td>${esc(t.date)}</td><td>${esc(t.description)}</td><td>${esc(t.type)}</td>
      <td class="nr mono">${isIn?fmt(t.amount):''}</td>
      <td class="nr mono">${!isIn?fmt(t.amount):''}</td>
      <td class="nr mono" style="font-weight:700;color:${bal>=0?'#1a6b45':'#8b2020'}">${fmt(bal)}</td>
      <td class="nc">${t.reconciled?'<span class="chip cg">‚úì Cleared</span>':'<span class="chip co">Pending</span>'}</td>
      <td class="nc"><button class="btn bout bxs" onclick="openSimple('bank_transactions','${t.id}')">Edit</button></td>
    </tr>`;
  }).join('');
  const totalIn=txns.filter(t=>['Deposit','Interest'].includes(t.type)).reduce((s,t)=>s+(t.amount||0),0);
  const totalOut=txns.filter(t=>!['Deposit','Interest'].includes(t.type)).reduce((s,t)=>s+(t.amount||0),0);
  return`
  <div class="kgrid kg3" style="margin-bottom:18px">
    <div class="kpi kg"><div class="kpi-lbl">Opening Balance</div><div class="kpi-val">${fmt(DB.settings.opening_balance||0)}</div></div>
    <div class="kpi kg"><div class="kpi-lbl">Total Deposits</div><div class="kpi-val">${fmt(totalIn)}</div></div>
    <div class="kpi kr"><div class="kpi-lbl">Total Withdrawals</div><div class="kpi-val">${fmt(totalOut)}</div></div>
  </div>
  <div class="card"><div class="ch"><h3>üè¶ Bank Transactions (Running Balance)</h3></div>
  <table class="tbl"><thead><tr><th>Date</th><th>Description</th><th>Type</th><th>Money In</th><th>Money Out</th><th>Balance</th><th>Status</th><th>Action</th></tr></thead>
  <tbody>${rows||'<tr class="erow"><td colspan="8">No bank transactions yet</td></tr>'}</tbody>
  </table></div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REPORTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderPnL(){
  const income=DB.income.reduce((s,r)=>s+(r.amount||0),0);
  const byCat=(arr,field)=>{
    const m={};arr.forEach(r=>{const k=r[field]||'Other';m[k]=(m[k]||0)+(r.amount||0);});return m;
  };
  const incByCat=byCat(DB.income,'category');
  const expByCat=byCat(DB.expenses,'category');
  const totalInc=income;
  const totalExp=DB.expenses.reduce((s,r)=>s+(r.amount||0),0);
  const gross=totalInc;
  const net=totalInc-totalExp;

  return`<div style="max-width:700px">
  <div class="section-hd"><h2>üìà Profit & Loss Statement</h2><button class="btn bout bsm" onclick="window.print()">üñ®Ô∏è Print</button></div>
  <div class="report-section">
    <div class="rs-head">INCOME</div>
    <div class="rs-body">
      ${Object.entries(incByCat).map(([k,v])=>`<div class="rs-row"><span class="rl indent">${esc(k)}</span><span class="rv positive">${fmt(v)}</span></div>`).join('')}
      <div class="rs-row subtotal"><span class="rl">Total Income</span><span class="rv positive">${fmt(totalInc)}</span></div>
    </div>
  </div>
  <div class="report-section">
    <div class="rs-head">EXPENSES</div>
    <div class="rs-body">
      ${Object.entries(expByCat).map(([k,v])=>`<div class="rs-row"><span class="rl indent">${esc(k)}</span><span class="rv negative">${fmt(v)}</span></div>`).join('')}
      <div class="rs-row subtotal"><span class="rl">Total Expenses</span><span class="rv negative">${fmt(totalExp)}</span></div>
    </div>
  </div>
  <div class="report-section">
    <div class="rs-body">
      <div class="rs-row total"><span class="rl">NET PROFIT / (LOSS)</span><span class="rv" style="color:${net>=0?'var(--gold-light)':'#ff8888'}">${fmt(net)}</span></div>
    </div>
  </div>
  <div class="alert-box alert-info" style="margin-top:16px;font-size:12px">‚ÑπÔ∏è This P&L is based on cash received and expenses paid. For accrual accounting, use invoice totals instead.</div>
  </div>`;
}

function renderBS(){
  const totalInc=DB.income.reduce((s,r)=>s+(r.amount||0),0);
  const totalExp=DB.expenses.reduce((s,r)=>s+(r.amount||0),0);
  const retained=totalInc-totalExp;
  const bankBal=(DB.settings.opening_balance||0)+DB.bank_transactions.filter(t=>['Deposit','Interest'].includes(t.type)).reduce((s,t)=>s+(t.amount||0),0)-DB.bank_transactions.filter(t=>!['Deposit','Interest'].includes(t.type)).reduce((s,t)=>s+(t.amount||0),0);
  const debtors=DB.invoices.filter(i=>i.status==='Unpaid'||i.status==='Partial').reduce((s,i)=>s+(i.total||0)-(i.paid||0),0);
  const invVal=DB.inventory.reduce((s,i)=>s+(i.qty||0)*(i.cost||0),0);
  const totalAssets=bankBal+debtors+invVal;
  const creditors=DB.purchase_orders.filter(p=>p.status!=='Received').reduce((s,p)=>s+(p.total||0),0);
  const equity=totalAssets-creditors;

  return`<div style="max-width:700px">
  <div class="section-hd"><h2>‚öñÔ∏è Balance Sheet</h2><button class="btn bout bsm" onclick="window.print()">üñ®Ô∏è Print</button></div>
  <div class="report-section">
    <div class="rs-head">ASSETS</div>
    <div class="rs-body">
      <div class="rs-row"><span class="rl indent">Cash & Bank Balance</span><span class="rv positive">${fmt(bankBal)}</span></div>
      <div class="rs-row"><span class="rl indent">Accounts Receivable (Debtors)</span><span class="rv">${fmt(debtors)}</span></div>
      <div class="rs-row"><span class="rl indent">Inventory Value (at cost)</span><span class="rv">${fmt(invVal)}</span></div>
      <div class="rs-row subtotal"><span class="rl">TOTAL ASSETS</span><span class="rv positive">${fmt(totalAssets)}</span></div>
    </div>
  </div>
  <div class="report-section">
    <div class="rs-head">LIABILITIES</div>
    <div class="rs-body">
      <div class="rs-row"><span class="rl indent">Accounts Payable (Creditors)</span><span class="rv negative">${fmt(creditors)}</span></div>
      <div class="rs-row subtotal"><span class="rl">TOTAL LIABILITIES</span><span class="rv negative">${fmt(creditors)}</span></div>
    </div>
  </div>
  <div class="report-section">
    <div class="rs-head">EQUITY</div>
    <div class="rs-body">
      <div class="rs-row"><span class="rl indent">Retained Earnings</span><span class="rv">${fmt(retained)}</span></div>
      <div class="rs-row total"><span class="rl">TOTAL EQUITY</span><span class="rv">${fmt(equity)}</span></div>
    </div>
  </div>
  <div class="alert-box alert-info" style="margin-top:16px;font-size:12px">‚ÑπÔ∏è Simplified balance sheet. For a full audited balance sheet, consult a certified accountant.</div>
  </div>`;
}

function renderVAT(){
  const vatPeriod=DB.settings.vat||18;
  const vatCollected=DB.invoices.filter(i=>i.applyVat&&i.status!=='Cancelled'&&i.status!=='Void').reduce((s,i)=>s+(i.vatAmt||0),0);
  const vatOnSales=DB.invoices.filter(i=>i.applyVat).reduce((s,i)=>s+(i.total||0),0);
  const vatPaid=DB.expenses.reduce((s,e)=>s+(e.vatAmount||0),0);
  const vatDue=vatCollected-vatPaid;

  const invRows=DB.invoices.filter(i=>i.applyVat).map(i=>`<tr>
    <td class="mono">${esc(i.ref)}</td><td>${esc(i.client)}</td><td>${esc(i.date)}</td>
    <td class="nr mono">${fmt(i.sub||0)}</td><td class="nr mono">${fmt(i.vatAmt||0)}</td>
    <td class="nr mono">${fmt(i.total||0)}</td><td>${chip(i.status||'')}</td>
  </tr>`).join('');

  const expRows=DB.expenses.filter(e=>e.vatAmount).map(e=>`<tr>
    <td>${esc(e.date)}</td><td>${esc(e.description)}</td><td>${esc(e.vendor||'')}</td>
    <td class="nr mono">${fmt(e.amount||0)}</td><td class="nr mono">${fmt(e.vatAmount||0)}</td>
  </tr>`).join('');

  return`<div>
  <div class="section-hd"><h2>üèõÔ∏è VAT / Tax Summary (${vatPeriod}%)</h2><button class="btn bout bsm" onclick="window.print()">üñ®Ô∏è Print</button></div>
  <div class="kgrid kg3" style="margin-bottom:18px">
    <div class="kpi kg"><div class="kpi-lbl">VAT Collected (Output)</div><div class="kpi-val">${fmt(vatCollected)}</div><div class="kpi-sub">On invoices issued</div></div>
    <div class="kpi kr"><div class="kpi-lbl">VAT Paid (Input)</div><div class="kpi-val">${fmt(vatPaid)}</div><div class="kpi-sub">On expenses</div></div>
    <div class="kpi ko"><div class="kpi-lbl">VAT Due to URA</div><div class="kpi-val" style="color:${vatDue>0?'#8b2020':'#1a6b45'}">${fmt(vatDue)}</div><div class="kpi-sub">${vatDue>0?'Payable to URA':'VAT credit'}</div></div>
  </div>
  ${vatDue>0?`<div class="alert-box alert-err" style="margin-bottom:16px">‚ö†Ô∏è You owe <strong>${fmt(vatDue)}</strong> VAT to Uganda Revenue Authority (URA). File your VAT return at <a href="https://ura.go.ug" target="_blank">ura.go.ug</a></div>`:''}
  <div class="card" style="margin-bottom:16px"><div class="ch"><h3>Sales (Output VAT)</h3></div>
  <table class="tbl"><thead><tr><th>Invoice</th><th>Client</th><th>Date</th><th>Net Amount</th><th>VAT (${vatPeriod}%)</th><th>Gross Total</th><th>Status</th></tr></thead>
  <tbody>${invRows||'<tr class="erow"><td colspan="7">No VAT invoices</td></tr>'}</tbody></table></div>
  <div class="card"><div class="ch"><h3>Purchases (Input VAT)</h3></div>
  <table class="tbl"><thead><tr><th>Date</th><th>Description</th><th>Vendor</th><th>Amount</th><th>VAT Paid</th></tr></thead>
  <tbody>${expRows||'<tr class="erow"><td colspan="5">No expense VAT recorded</td></tr>'}</tbody></table></div>
  </div>`;
}

function renderAged(){
  const now=today();
  const bs={};
  DB.invoices.filter(i=>i.status==='Unpaid'||i.status==='Partial').forEach(inv=>{
    const bal=(inv.total||0)-(inv.paid||0);if(bal<=0)return;
    const days=inv.due?daysBetween(inv.due,now):0;
    const bucket=days<=0?'Current':days<=30?'1-30 days':days<=60?'31-60 days':days<=90?'61-90 days':'90+ days';
    if(!bs[bucket])bs[bucket]=[];
    bs[bucket].push({...inv,bal,days:Math.max(0,days)});
  });
  const allBuckets=['Current','1-30 days','31-60 days','61-90 days','90+ days'];
  const totals={};let grandTotal=0;
  allBuckets.forEach(b=>{totals[b]=(bs[b]||[]).reduce((s,i)=>s+i.bal,0);grandTotal+=totals[b];});
  const kpiColors=['kg','co','cr','cr','cr'];

  return`<div>
  <div class="section-hd"><h2>‚è∞ Aged Debtors Report</h2></div>
  <div class="kgrid" style="grid-template-columns:repeat(5,1fr);margin-bottom:18px">
    ${allBuckets.map((b,i)=>`<div class="kpi ${kpiColors[i]}"><div class="kpi-lbl">${b}</div><div class="kpi-val" style="font-size:15px">${fmt(totals[b]||0)}</div><div class="kpi-sub">${(bs[b]||[]).length} invoice(s)</div></div>`).join('')}
  </div>
  ${grandTotal>0?`<div class="alert-box alert-err" style="margin-bottom:16px">üí∞ Total outstanding: <strong>${fmt(grandTotal)}</strong> across ${allBuckets.reduce((s,b)=>s+(bs[b]||[]).length,0)} invoice(s)</div>`:'<div class="alert-box alert-ok" style="margin-bottom:16px">‚úÖ No outstanding debts. All invoices are paid!</div>'}
  <div class="card"><div class="ch"><h3>Debtor Details</h3></div>
  <table class="tbl"><thead><tr><th>Client</th><th>Invoice</th><th>Invoice Date</th><th>Due Date</th><th>Days Overdue</th><th>Invoice Total</th><th>Paid</th><th>Balance Due</th><th>Action</th></tr></thead>
  <tbody>${allBuckets.flatMap(b=>(bs[b]||[]).map(i=>{const rowbg=i.days>30?'background:#fffafa':'';return`<tr style="${rowbg}">
    <td><strong>${esc(i.client)}</strong></td>
    <td class="mono">${esc(i.ref)}</td>
    <td>${esc(i.date)}</td>
    <td>${esc(i.due||'‚Äî')}</td>
    <td style="color:${i.days>0?'#8b2020':'#1a6b45'};font-weight:${i.days>0?700:400}">${i.days>0?i.days+' days':'Current'}</td>
    <td class="nr mono">${fmt(i.total||0)}</td>
    <td class="nr mono">${fmt(i.paid||0)}</td>
    <td class="nr mono" style="color:#8b2020;font-weight:700">${fmt(i.bal)}</td>
    <td class="nc"><button class="btn bgreen bxs" onclick="recordPayment('${i.id}')">üí∞ Pay</button></td>
  </tr>`;})).join('')||'<tr class="erow"><td colspan="9">No outstanding invoices</td></tr>'}</tbody>
  </table></div></div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STOCK MOVEMENTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function logStockMovement(direction,invItem,qty,ref,reason){
  DB.stock_movements.push({
    id:uid(),date:today(),direction,
    itemId:invItem.id,itemName:invItem.name,
    qty,unit:invItem.unit||'pcs',
    balanceAfter:invItem.qty,
    ref:ref||'',reason:reason||'',
    createdAt:new Date().toISOString()
  });
  save('stock_movements');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INVENTORY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderInventory(tab){
  tab=tab||'stock';
  const rows=DB.inventory;
  const totalVal=rows.reduce((s,i)=>s+(i.qty||0)*(i.cost||0),0);
  const totalSellVal=rows.reduce((s,i)=>s+(i.qty||0)*(i.price||0),0);
  const lowItems=rows.filter(i=>(i.qty||0)<=(i.reorder||5));
  const movements=[...DB.stock_movements].sort((a,b)=>(b.createdAt||'').localeCompare(a.createdAt||'')).slice(0,100);

  const stockRows=rows.length?rows.map(r=>{
    const status=r.qty<=0?'Out of Stock':r.qty<=(r.reorder||5)?'Low Stock':'In Stock';
    const margin=r.price&&r.cost?Math.round((r.price-r.cost)/r.price*100):0;
    return`<tr>
      <td><strong>${esc(r.name)}</strong>${r.sku?`<br><span class="mono" style="font-size:10px;color:var(--ink-muted)">${esc(r.sku)}</span>`:''}</td>
      <td>${esc(r.category||'‚Äî')}</td>
      <td style="color:${r.qty<=0?'#8b2020':r.qty<=(r.reorder||5)?'#b85c00':'#1a6b45'};font-weight:700;text-align:center">${r.qty||0} ${esc(r.unit||'pcs')}</td>
      <td style="text-align:center;color:var(--ink-muted)">${r.reorder||5}</td>
      <td class="nr mono">${fmt(r.cost||0)}</td>
      <td class="nr mono">${fmt(r.price||0)}</td>
      <td style="text-align:center;color:${margin>20?'#1a6b45':'#b85c00'};font-weight:600">${margin}%</td>
      <td class="nr mono">${fmt((r.qty||0)*(r.cost||0))}</td>
      <td>${chip(status)}</td>
      <td class="nc" style="white-space:nowrap">
        <button class="btn bout bxs" onclick="openSimple('inventory','${r.id}')">Edit</button>
        <button class="btn bsm" style="background:#e6ecf4;color:#1a3a6b;border:none;border-radius:4px;padding:3px 8px;font-size:11px;cursor:pointer;font-family:'DM Sans',sans-serif" onclick="adjustStock('${r.id}')">¬± Adjust</button>
        <button class="btn bred bxs" onclick="del('inventory','${r.id}')">Del</button>
      </td>
    </tr>`;
  }).join(''):'<tr class="erow"><td colspan="10">No inventory items yet ‚Äî add items manually or receive a Purchase Order</td></tr>';

  const movRows=movements.length?movements.map(m=>`<tr>
    <td>${esc(m.date)}</td>
    <td><strong>${esc(m.itemName)}</strong></td>
    <td class="nc"><span class="chip ${m.direction==='IN'?'cg':'cr'}">${m.direction==='IN'?'‚ñ≤ IN':'‚ñº OUT'}</span></td>
    <td style="text-align:center;font-weight:700;color:${m.direction==='IN'?'#1a6b45':'#8b2020'}">${m.direction==='IN'?'+':'‚àí'}${m.qty} ${esc(m.unit||'')}</td>
    <td style="text-align:center" class="mono">${m.balanceAfter??'‚Äî'}</td>
    <td class="mono">${esc(m.ref||'‚Äî')}</td>
    <td>${esc(m.reason||'')}</td>
  </tr>`).join(''):'<tr class="erow"><td colspan="7">No stock movements yet ‚Äî create a delivery note or receive a purchase order to see movements here</td></tr>';

  return`
  <div class="kgrid" style="grid-template-columns:repeat(4,1fr);margin-bottom:16px">
    <div class="kpi ko"><div class="kpi-lbl">Total Items</div><div class="kpi-val">${rows.length}</div></div>
    <div class="kpi kb"><div class="kpi-lbl">Cost Value</div><div class="kpi-val" style="font-size:15px">${fmt(totalVal)}</div></div>
    <div class="kpi kg"><div class="kpi-lbl">Sell Value</div><div class="kpi-val" style="font-size:15px">${fmt(totalSellVal)}</div></div>
    <div class="kpi kr"><div class="kpi-lbl">Low / Out of Stock</div><div class="kpi-val">${lowItems.length}</div></div>
  </div>
  ${lowItems.length?`<div class="alert-box alert-err" style="margin-bottom:14px">‚ö†Ô∏è <strong>Low/Out of Stock:</strong> ${lowItems.map(i=>esc(i.name)+' ('+i.qty+' left)').join(', ')} ‚Äî <a onclick="openDocForm('purchase_order')" style="cursor:pointer;text-decoration:underline;font-weight:700">Create Purchase Order ‚Üí</a></div>`:''}
  <div class="tab-bar">
    <div class="tab ${tab==='stock'?'active':''}" onclick="document.getElementById('content').innerHTML=renderInventory('stock')">üì¶ Stock Levels</div>
    <div class="tab ${tab==='movements'?'active':''}" onclick="document.getElementById('content').innerHTML=renderInventory('movements')">üìã Stock Movements</div>
  </div>
  ${tab==='stock'?`
  <div class="card"><div class="ch"><h3>üì¶ Inventory (${rows.length} items)</h3>
    <button class="btn bout bsm" onclick="exportInventoryCSV()">‚¨áÔ∏è Export CSV</button>
  </div>
  <table class="tbl"><thead><tr><th>Item</th><th>Category</th><th>In Stock</th><th>Reorder At</th><th>Cost Price</th><th>Sell Price</th><th>Margin</th><th>Stock Value</th><th>Status</th><th>Actions</th></tr></thead>
  <tbody>${stockRows}</tbody></table></div>`:`
  <div class="card"><div class="ch"><h3>üìã Stock Movement History</h3><span style="font-size:11.5px;color:var(--ink-muted)">Last 100 entries</span></div>
  <table class="tbl"><thead><tr><th>Date</th><th>Item</th><th>Direction</th><th>Qty Change</th><th>Balance After</th><th>Document Ref</th><th>Reason</th></tr></thead>
  <tbody>${movRows}</tbody></table></div>`}`;
}

function adjustStock(invId){
  const item=DB.inventory.find(r=>r.id===invId);if(!item)return;
  $('fmtitle').textContent='Adjust Stock ‚Äî '+item.name;
  $('fmodalbox').style.maxWidth='420px';
  $('fmbody').innerHTML=`<div class="fg2">
    <div class="fg s2" style="background:var(--gold-pale);padding:12px;border-radius:var(--r)">
      <div style="font-size:13px;font-weight:700">${esc(item.name)}</div>
      <div style="font-size:12px;color:var(--ink-soft);margin-top:3px">Current stock: <strong>${item.qty} ${item.unit||'pcs'}</strong></div>
    </div>
    <div class="fg"><label class="fl">Adjustment Type</label><select class="fs" id="adj-type">
      <option value="IN">‚ñ≤ Add Stock (e.g. new delivery)</option>
      <option value="OUT">‚ñº Remove Stock (e.g. damaged)</option>
      <option value="SET">= Set Exact Quantity (stocktake)</option>
    </select></div>
    <div class="fg"><label class="fl">Quantity</label><input type="number" class="fi" id="adj-qty" min="0" placeholder="e.g. 10"></div>
    <div class="fg s2"><label class="fl">Reason</label><select class="fs" id="adj-reason">
      <option>Stocktake / Count Correction</option>
      <option>Damaged / Expired</option>
      <option>Returned by Customer</option>
      <option>Internal Use</option>
      <option>Opening Stock</option>
      <option>Other</option>
    </select></div>
    <div class="fg s2"><label class="fl">Notes</label><input class="fi" id="adj-notes" placeholder="Optional details"></div>
  </div>`;
  $('fmfoot').innerHTML=`<button class="btn bout" onclick="closeFM()">Cancel</button><button class="btn bg" onclick="applyStockAdj('${invId}')">‚úÖ Apply Adjustment</button>`;
  $('fmodal').classList.add('open');
}

async function applyStockAdj(invId){
  const item=DB.inventory.find(r=>r.id===invId);if(!item)return;
  const type=gv('adj-type'),qty=parseFloat(gv('adj-qty'))||0,reason=gv('adj-reason')+(gv('adj-notes')?' ‚Äî '+gv('adj-notes'):'');
  if(qty<=0&&type!=='SET'){toast('Enter a valid quantity','warn');return;}
  if(type==='IN')item.qty=(item.qty||0)+qty;
  else if(type==='OUT')item.qty=Math.max(0,(item.qty||0)-qty);
  else item.qty=qty;
  logStockMovement(type==='OUT'?'OUT':'IN',item,type==='SET'?qty:qty,'Manual Adjustment',reason);
  await save('inventory');
  closeFM();toast(`‚úÖ Stock adjusted: ${item.name} ‚Üí ${item.qty} ${item.unit||'pcs'}`);nav('inventory');
}

function exportInventoryCSV(){
  const rows=[['Name','SKU','Category','Qty','Unit','Cost Price','Sell Price','Stock Value','Reorder Level','Status']];
  DB.inventory.forEach(r=>{
    const status=r.qty<=0?'Out of Stock':r.qty<=(r.reorder||5)?'Low Stock':'In Stock';
    rows.push([r.name,r.sku||'',r.category||'',r.qty,r.unit||'pcs',r.cost||0,r.price||0,(r.qty||0)*(r.cost||0),r.reorder||5,status]);
  });
  const csv=rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  const a=document.createElement('a');a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv);
  a.download='Sumureza_Inventory_'+today()+'.csv';a.click();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETTINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderSettings(){
  const s=DB.settings;
  return`<div class="card"><div class="ch"><h3>üè¢ Company Information</h3></div><div class="cb">
  <div class="fg2">
    <div class="fg s2"><label class="fl">Company Name</label><input class="fi" id="s-name" value="${esc(s.name)}"></div>
    <div class="fg s2"><label class="fl">Tagline</label><input class="fi" id="s-tagline" value="${esc(s.tagline)}"></div>
    <div class="fg s2"><label class="fl">Address</label><input class="fi" id="s-address" value="${esc(s.address)}"></div>
    <div class="fg"><label class="fl">Phone</label><input class="fi" id="s-phone" value="${esc(s.phone)}"></div>
    <div class="fg"><label class="fl">Email</label><input class="fi" id="s-email" value="${esc(s.email)}"></div>
    <div class="fg"><label class="fl">Website</label><input class="fi" id="s-website" value="${esc(s.website)}"></div>
    <div class="fg"><label class="fl">TIN / Tax No.</label><input class="fi" id="s-tin" value="${esc(s.tin)}"></div>
    <div class="fg"><label class="fl">Currency Code</label><input class="fi" id="s-currency" value="${esc(s.currency||'UGX')}"></div>
    <div class="fg"><label class="fl">VAT Rate (%)</label><input type="number" class="fi" id="s-vat" value="${s.vat||18}"></div>
  </div>
  <hr class="divider">
  <div class="fg2">
    <div class="fg s2"><label class="fl">Bank Name</label><input class="fi" id="s-bank" value="${esc(s.bank_name||'')}"></div>
    <div class="fg"><label class="fl">Account Number</label><input class="fi" id="s-acc" value="${esc(s.bank_account||'')}"></div>
    <div class="fg"><label class="fl">Opening Bank Balance (UGX)</label><input type="number" class="fi" id="s-ob" value="${s.opening_balance||0}"></div>
  </div>
  <div class="actions-row"><button class="btn bg" onclick="saveSettings()">üíæ Save Settings${driveCon()?' & Sync':''}</button></div>
  </div></div>`;
}

async function saveSettings(){
  Object.assign(DB.settings,{name:gv('s-name'),tagline:gv('s-tagline'),address:gv('s-address'),phone:gv('s-phone'),email:gv('s-email'),website:gv('s-website'),tin:gv('s-tin'),currency:gv('s-currency'),vat:parseFloat(gv('s-vat'))||18,bank_name:gv('s-bank'),bank_account:gv('s-acc'),opening_balance:parseFloat(gv('s-ob'))||0});
  await save('settings');toast('‚úÖ Settings saved'+( driveCon()?' & synced':'')+'!');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GOOGLE DRIVE PAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderGDrive(){
  const ok=driveOk(),con=driveCon();
  return`
  ${con?`<div class="alert-box alert-ok" style="display:flex;align-items:center;gap:16px;margin-bottom:18px">
    <span style="font-size:26px">‚òÅÔ∏è</span>
    <div><div style="font-weight:700;font-size:14px">Google Drive Connected!</div>
    <div style="font-size:12.5px;margin-top:2px">Signed in as <strong>${DRIVE.userEmail||'...'}</strong> ¬∑ Folder: <strong>Sumureza Business Data</strong></div></div>
    <div style="margin-left:auto;display:flex;gap:8px">
      <button class="btn bout bsm" onclick="loadAll().then(()=>{nav('dashboard');toast('Data reloaded ‚úì')})">‚ü≥ Reload from Drive</button>
      <button class="btn bred bsm" onclick="if(confirm('Disconnect?')){DRIVE.token=null;localStorage.removeItem('sgd_tok');updateDriveUI();nav('gdrive');}">Disconnect</button>
    </div></div>`:`<div class="alert-box alert-warn" style="margin-bottom:18px"><strong>‚ö†Ô∏è Not connected.</strong> Follow the steps below. Your data is saved in this browser only until you connect.</div>`}

  <div class="alert-box alert-info" style="margin-bottom:18px">
    <strong>üìã Important:</strong> When creating your OAuth Client ID, under <strong>Authorized JavaScript Origins</strong>, you must add your GitHub Pages URL like:<br>
    <code style="display:block;margin-top:6px;padding:8px;background:rgba(0,0,0,.06);border-radius:4px;font-family:'DM Mono',monospace">https://YOUR-USERNAME.github.io</code>
    This is why it must be hosted on GitHub Pages ‚Äî Google blocks OAuth on local files.
  </div>

  <div class="sstep"><div class="snum">1</div><div class="sbody"><h4>Host on GitHub Pages (if not done)</h4><p>Upload this <code>index.html</code> file to a GitHub repository, enable Pages in Settings ‚Üí Pages ‚Üí Deploy from main branch.</p><a class="slink" href="https://github.com/new" target="_blank">üîó Create GitHub Repo</a></div></div>
  <div class="sstep"><div class="snum">2</div><div class="sbody"><h4>Create Google Cloud Project & Enable Drive API</h4><p>Create project ‚Üí APIs & Services ‚Üí Library ‚Üí Enable <strong>Google Drive API</strong></p><a class="slink" href="https://console.cloud.google.com" target="_blank">üîó Google Cloud Console</a></div></div>
  <div class="sstep"><div class="snum">3</div><div class="sbody"><h4>OAuth Consent Screen</h4><p>APIs & Services ‚Üí OAuth Consent Screen ‚Üí External ‚Üí Fill name ‚Üí Add your Gmail as test user</p></div></div>
  <div class="sstep"><div class="snum">4</div><div class="sbody"><h4>Create API Key & OAuth Client ID</h4>
    <p><strong>API Key:</strong> Credentials ‚Üí Create Credentials ‚Üí API Key<br>
    <strong>OAuth Client ID:</strong> Credentials ‚Üí OAuth Client ID ‚Üí Web Application<br>
    Under <strong>Authorized JavaScript Origins</strong> add: <code>https://YOUR-USERNAME.github.io</code></p></div></div>

  <div class="card"><div class="ch"><h3>üîë Enter Your Credentials</h3></div><div class="cb">
    <div class="fg2">
      <div class="fg s2"><label class="fl">OAuth 2.0 Client ID</label><input class="fi" id="g-cid" value="${esc(DRIVE.clientId)}" placeholder="123456789-abc...apps.googleusercontent.com"></div>
      <div class="fg s2"><label class="fl">API Key</label><input class="fi" id="g-akey" value="${esc(DRIVE.apiKey)}" placeholder="AIzaSy..."></div>
    </div>
    <div style="margin-top:10px;padding:10px 14px;background:#f8f7f5;border-radius:var(--r);font-size:11.5px;color:var(--ink-muted)">üîí Credentials stored in your browser only ‚Äî never sent anywhere except Google's servers.</div>
    <div class="actions-row">
      ${ok&&!con?`<button class="btn bgreen" onclick="driveSignIn()">üîó Connect Google Drive</button>`:''}
      <button class="btn bg" onclick="saveCreds()">üíæ Save Credentials</button>
    </div>
  </div></div>`;
}

function saveCreds(){
  const cid=gv('g-cid').trim(),akey=gv('g-akey').trim();
  if(!cid||!akey){toast('Enter both fields','warn');return;}
  DRIVE.clientId=cid;DRIVE.apiKey=akey;
  localStorage.setItem('sgd_cid',cid);localStorage.setItem('sgd_akey',akey);
  loadGAPIs();setTimeout(()=>{updateDriveUI();nav('gdrive');},1200);
  toast('‚úÖ Credentials saved! Click "Connect Google Drive" to sign in.');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PIN AUTHENTICATION SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const PIN_PAGES_ALL=['dashboard','quotations','purchase_orders','invoices','delivery','receipts','income','expenses','bank','pnl','balance_sheet','vat','aged_debtors','inventory','clients','suppliers','settings','gdrive','pin_management'];
const PIN_PAGES_RESTRICTED=['dashboard','quotations','invoices','delivery','receipts','income','inventory','clients'];

// Default users ‚Äî stored in localStorage under 'sgd_users'
let USERS=[];
let currentUser=null;
let pinBuffer='';
let pinTargetUser=null;

function defaultUsers(){
  return[
    {id:'admin',name:'Admin',role:'admin',pin:hashPin('1234'),pages:PIN_PAGES_ALL,active:true},
  ];
}

function hashPin(pin){
  // Simple obfuscation ‚Äî XOR with key + base64
  const key='SUMUREZA2025';
  let out='';
  for(let i=0;i<pin.length;i++) out+=String.fromCharCode(pin.charCodeAt(i)^key.charCodeAt(i%key.length));
  return btoa(out);
}

function verifyPin(stored,entered){return hashPin(entered)===stored;}

function loadUsers(){
  try{const u=localStorage.getItem('sgd_users');if(u){USERS=JSON.parse(u);return;}}catch(e){}
  USERS=defaultUsers();saveUsers();
}

function saveUsers(){localStorage.setItem('sgd_users',JSON.stringify(USERS));}

function initPinScreen(){
  loadUsers();
  const active=USERS.filter(u=>u.active!==false);
  // If no PIN set yet (first run with only default), skip PIN
  if(USERS.length===1&&USERS[0].pin===hashPin('1234')&&!localStorage.getItem('sgd_pin_setup')){
    // Show setup prompt instead
    unlockAsUser(USERS[0]);
    showFirstRunSetup();
    return;
  }
  showUserSel();
}

function showFirstRunSetup(){
  // Notify admin to set up PIN
  setTimeout(()=>{
    toast('‚ö†Ô∏è Default PIN is 1234 ‚Äî please change it in üîê PIN Management!','warn');
  },1500);
}

function showUserSel(){
  const active=USERS.filter(u=>u.active!==false);
  $('pinUserSel').style.display='';
  $('pinEntry').style.display='none';
  pinBuffer='';pinTargetUser=null;
  const list=$('pinUserList');
  list.innerHTML=active.map(u=>`
    <button class="pin-user-btn" onclick="selectPinUser('${u.id}')">
      <span style="font-size:20px">${u.role==='admin'?'üëë':u.role==='cashier'?'üí∞':u.role==='sales'?'üìã':'üë§'}</span>
      <div><div style="font-weight:600">${esc(u.name)}</div><div class="pin-user-role">${u.role}</div></div>
    </button>`).join('');
}

function selectPinUser(userId){
  pinTargetUser=USERS.find(u=>u.id===userId);
  if(!pinTargetUser)return;
  $('pinUserSel').style.display='none';
  $('pinEntry').style.display='';
  $('pinWhoLbl').textContent='Hello, '+pinTargetUser.name+'! Enter your PIN';
  pinBuffer='';
  renderPinDots();
  $('pinErr').textContent='';
}

function renderPinDots(){
  const dots=$('pinDots');
  dots.innerHTML='';
  for(let i=0;i<4;i++){
    const d=document.createElement('div');
    d.className='pin-dot'+(i<pinBuffer.length?' filled':'');
    dots.appendChild(d);
  }
}

function pinPress(n){
  if(pinBuffer.length>=4)return;
  pinBuffer+=n;
  renderPinDots();
  $('pinErr').textContent='';
  if(pinBuffer.length===4)setTimeout(checkPin,120);
}

function pinBack(){if(pinBuffer.length>0){pinBuffer=pinBuffer.slice(0,-1);renderPinDots();}}
function pinClear(){pinBuffer='';renderPinDots();$('pinErr').textContent='';}

function checkPin(){
  if(!pinTargetUser)return;
  if(verifyPin(pinTargetUser.pin,pinBuffer)){
    unlockAsUser(pinTargetUser);
  } else {
    // shake dots red
    const dots=$('pinDots').querySelectorAll('.pin-dot');
    dots.forEach(d=>{d.classList.add('error');d.classList.remove('filled');});
    $('pinErr').textContent='Incorrect PIN. Try again.';
    setTimeout(()=>{dots.forEach(d=>d.classList.remove('error'));pinBuffer='';renderPinDots();},700);
  }
}

function unlockAsUser(user){
  currentUser=user;
  $('pinScreen').style.display='none';
  // Show/hide nav items based on role
  applyAccessControl(user);
  // Show lock button and user info
  $('lockBtn').style.display='block';
  $('curUserBar').style.display='block';
  $('curUserBar').innerHTML=`<div style="color:rgba(255,255,255,.4);font-size:10.5px">Signed in as</div><div style="color:rgba(200,150,42,.85);font-size:12px;font-weight:700">${esc(user.name)} ¬∑ ${user.role}</div>`;
  // Show PIN management only for admin
  $('ni-pin').style.display=user.role==='admin'?'flex':'none';
  // Navigate to dashboard
  nav('dashboard');
}

function applyAccessControl(user){
  const allowed=user.pages||PIN_PAGES_ALL;
  document.querySelectorAll('.ni').forEach(el=>{
    const onclick=el.getAttribute('onclick')||'';
    const match=onclick.match(/nav\('([^']+)'\)/);
    if(match){
      const page=match[1];
      if(page==='pin_management')return; // handled separately
      el.style.display=(!allowed.includes(page)&&user.role!=='admin')?'none':'flex';
    }
  });
}

function lockApp(){
  if(!confirm('Lock the app?'))return;
  currentUser=null;
  $('lockBtn').style.display='none';
  $('curUserBar').style.display='none';
  $('pinScreen').style.display='flex';
  // Restore all nav items
  document.querySelectorAll('.ni').forEach(el=>el.style.display='flex');
  showUserSel();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PIN MANAGEMENT PAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderPinMgmt(){
  if(currentUser?.role!=='admin'){return`<div class="alert-box alert-err">üîí Only admins can manage PINs.</div>`;}
  const rows=USERS.map(u=>`<tr>
    <td><strong>${esc(u.name)}</strong></td>
    <td>${chip(u.role==='admin'?'Active':u.role==='cashier'?'Active':u.role==='sales'?'Active':'Active')}<span style="font-size:11px;margin-left:6px;color:var(--ink-muted)">${u.role}</span></td>
    <td class="nc">${u.active!==false?'<span class="chip cg">Active</span>':'<span class="chip cr">Disabled</span>'}</td>
    <td class="nc">
      <button class="btn bout bxs" onclick="openEditUser('${u.id}')">Edit</button>
      <button class="btn bout bxs" onclick="openChangePin('${u.id}')">Change PIN</button>
      ${u.id!=='admin'?`<button class="btn bred bxs" onclick="deleteUser('${u.id}')">Del</button>`:''}
    </td>
  </tr>`).join('');

  return`<div>
  <div class="section-hd"><h2>üîê PIN Management</h2><button class="btn bg" onclick="openAddUser()">+ Add Staff Member</button></div>
  <div class="alert-box alert-info" style="margin-bottom:16px">
    ‚ÑπÔ∏è Each staff member has a 4-digit PIN. <strong>Admin</strong> can access everything. You can restrict what pages other staff can see.
  </div>
  <div class="card"><div class="ch"><h3>Staff Users (${USERS.length})</h3></div>
  <table class="tbl"><thead><tr><th>Name</th><th>Role</th><th>Status</th><th>Actions</th></tr></thead>
  <tbody>${rows}</tbody></table></div>

  <div class="card" style="margin-top:16px"><div class="ch"><h3>üìã Role Permissions</h3></div><div class="cb">
    <table class="tbl"><thead><tr><th>Page</th><th>Admin</th><th>Cashier</th><th>Sales</th><th>Viewer</th></tr></thead>
    <tbody>
      ${[['Dashboard','‚úÖ','‚úÖ','‚úÖ','‚úÖ'],['Quotations','‚úÖ','‚ùå','‚úÖ','üëÅ'],['Invoices','‚úÖ','‚úÖ','‚úÖ','üëÅ'],['Receipts','‚úÖ','‚úÖ','‚úÖ','üëÅ'],['Income','‚úÖ','‚úÖ','‚ùå','‚ùå'],['Expenses','‚úÖ','‚úÖ','‚ùå','‚ùå'],['Reports (P&L, VAT...)','‚úÖ','‚ùå','‚ùå','‚ùå'],['Inventory','‚úÖ','‚úÖ','‚úÖ','üëÅ'],['Clients','‚úÖ','‚úÖ','‚úÖ','üëÅ'],['Settings','‚úÖ','‚ùå','‚ùå','‚ùå'],['PIN Management','‚úÖ','‚ùå','‚ùå','‚ùå']].map(r=>`<tr>${r.map(c=>`<td style="text-align:center">${c}</td>`).join('')}</tr>`).join('')}
    </tbody></table>
    <div style="font-size:11.5px;color:var(--ink-muted);margin-top:10px">‚úÖ Full access &nbsp; üëÅ View only (no add/edit/delete) &nbsp; ‚ùå No access</div>
  </div></div>
  </div>`;
}

const ROLE_PAGES={
  admin:PIN_PAGES_ALL,
  cashier:['dashboard','invoices','receipts','income','expenses','inventory','clients'],
  sales:['dashboard','quotations','invoices','delivery','receipts','inventory','clients'],
  viewer:['dashboard','quotations','invoices','receipts','inventory','clients'],
};

function openAddUser(){
  $('fmtitle').textContent='Add Staff Member';
  $('fmodalbox').style.maxWidth='460px';
  $('fmbody').innerHTML=`<div class="fg2">
    <div class="fg s2"><label class="fl">Full Name *</label><input class="fi" id="u-name" placeholder="e.g. Sarah Nakato"></div>
    <div class="fg"><label class="fl">Role</label><select class="fs" id="u-role" onchange="roleChanged()">
      <option value="cashier">Cashier</option>
      <option value="sales">Sales</option>
      <option value="viewer">Viewer</option>
      <option value="admin">Admin</option>
    </select></div>
    <div class="fg"><label class="fl">4-Digit PIN *</label><input type="password" class="fi" id="u-pin" maxlength="4" placeholder="e.g. 5678" inputmode="numeric"></div>
    <div class="fg"><label class="fl">Confirm PIN *</label><input type="password" class="fi" id="u-pin2" maxlength="4" placeholder="Repeat PIN" inputmode="numeric"></div>
    <div class="fg s2"><label class="fl" style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="u-active" checked> Account Active</label></div>
  </div>`;
  $('fmfoot').innerHTML=`<button class="btn bout" onclick="closeFM()">Cancel</button><button class="btn bg" onclick="saveNewUser()">üíæ Add User</button>`;
  $('fmodal').classList.add('open');
}

function openEditUser(uid2){
  const u=USERS.find(x=>x.id===uid2);if(!u)return;
  $('fmtitle').textContent='Edit ‚Äî '+u.name;
  $('fmodalbox').style.maxWidth='460px';
  $('fmbody').innerHTML=`<div class="fg2">
    <div class="fg s2"><label class="fl">Full Name *</label><input class="fi" id="u-name" value="${esc(u.name)}"></div>
    <div class="fg"><label class="fl">Role</label><select class="fs" id="u-role">
      ${['cashier','sales','viewer','admin'].map(r=>`<option value="${r}" ${u.role===r?'selected':''}>${r.charAt(0).toUpperCase()+r.slice(1)}</option>`).join('')}
    </select></div>
    <div class="fg s2"><label class="fl" style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="u-active" ${u.active!==false?'checked':''}> Account Active</label></div>
  </div>`;
  $('fmfoot').innerHTML=`<button class="btn bout" onclick="closeFM()">Cancel</button><button class="btn bg" onclick="saveEditUser('${uid2}')">üíæ Save</button>`;
  $('fmodal').classList.add('open');
}

function openChangePin(uid2){
  const u=USERS.find(x=>x.id===uid2);if(!u)return;
  $('fmtitle').textContent='Change PIN ‚Äî '+u.name;
  $('fmodalbox').style.maxWidth='400px';
  $('fmbody').innerHTML=`<div class="fg2">
    <div class="fg s2"><label class="fl">New 4-Digit PIN *</label><input type="password" class="fi" id="u-pin" maxlength="4" placeholder="e.g. 9012" inputmode="numeric"></div>
    <div class="fg s2"><label class="fl">Confirm New PIN *</label><input type="password" class="fi" id="u-pin2" maxlength="4" placeholder="Repeat PIN" inputmode="numeric"></div>
  </div>`;
  $('fmfoot').innerHTML=`<button class="btn bout" onclick="closeFM()">Cancel</button><button class="btn bg" onclick="saveChangePin('${uid2}')">üîë Update PIN</button>`;
  $('fmodal').classList.add('open');
}

function saveNewUser(){
  const name=gv('u-name').trim(),role=gv('u-role'),pin=gv('u-pin'),pin2=gv('u-pin2'),active=$('u-active').checked;
  if(!name){toast('Name required','warn');return;}
  if(!/^\d{4}$/.test(pin)){toast('PIN must be exactly 4 digits','warn');return;}
  if(pin!==pin2){toast('PINs do not match','warn');return;}
  USERS.push({id:uid(),name,role,pin:hashPin(pin),pages:ROLE_PAGES[role]||PIN_PAGES_RESTRICTED,active});
  saveUsers();closeFM();toast('‚úÖ Staff member added!');nav('pin_management');
}

function saveEditUser(uid2){
  const u=USERS.find(x=>x.id===uid2);if(!u)return;
  u.name=gv('u-name').trim()||u.name;
  u.role=gv('u-role');
  u.pages=ROLE_PAGES[u.role]||PIN_PAGES_RESTRICTED;
  u.active=$('u-active').checked;
  saveUsers();closeFM();toast('‚úÖ User updated!');nav('pin_management');
}

function saveChangePin(uid2){
  const u=USERS.find(x=>x.id===uid2);if(!u)return;
  const pin=gv('u-pin'),pin2=gv('u-pin2');
  if(!/^\d{4}$/.test(pin)){toast('PIN must be 4 digits','warn');return;}
  if(pin!==pin2){toast('PINs do not match','warn');return;}
  u.pin=hashPin(pin);
  saveUsers();closeFM();
  localStorage.setItem('sgd_pin_setup','1');
  toast('‚úÖ PIN changed successfully!');nav('pin_management');
}

function deleteUser(uid2){
  if(!confirm('Delete this user?'))return;
  USERS=USERS.filter(u=>u.id!==uid2);
  saveUsers();toast('User deleted');nav('pin_management');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODAL UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function closeFM(){$('fmodal').classList.remove('open');$('fmodalbox').style.maxWidth='820px';editId=null;editKey=null;}
function closeDM(){$('dmodal').classList.remove('open');}
$('fmodal').addEventListener('click',e=>{if(e.target.id==='fmodal')closeFM();});
$('dmodal').addEventListener('click',e=>{if(e.target.id==='dmodal')closeDM();});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
loadLocal();
loadGAPIs();
updateDriveUI();
initPinScreen();
</script>
</body>
</html>
